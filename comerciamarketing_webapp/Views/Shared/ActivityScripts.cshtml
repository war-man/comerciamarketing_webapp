
@{
    Layout = null;
}


<script type="text/javascript">
    window.onload = function () {
        //PARA RADIO BUTTONS
        $('.parentdiv').on('change', '.rad', function () {

            var id = $(this).attr('id');
            var parent = $(this).attr('name');



            if ($(this).is(':checked')) {
                $('.childdiv' + parent).hide();
                $('#radiodiv_' + id).show();
            } else {
      
            }
        });

        $('.parentdiv').on('change', '.chk', function () {
     
            var id = $(this).attr('id');
            var parent = $(this).attr('name');



            if ($(this).is(':checked')) {
               
                $('#radiodiv_' + id).show();
            } else {
                $('#radiodiv_' + id).hide();
            }
        });

        if (document.getElementById("brands_list")) {
            getBrands();
        } else {
     
        }
      
       
    };


    function getBrands() {
        var customerId = $("#customer_list").val();
        var idvisita = "";
        idvisita = document.getElementById('idvisita').value;


        $.ajax
            ({
                url: '/FormsM/Getbrands',
                type: 'POST',
                datatype: 'application/json',
                contentType: 'application/json',
                data: JSON.stringify({
                    customerID: customerId,
                    idvisit: idvisita
                }),
                success: function (result) {

                    $("#brands_list").html("");
                    $("#brands_list").append($('<option></option>').val(0).html("Seleccione una marca"))
                    $.each($.parseJSON(result), function (i, brands) {
                        if (brands.isselected) {//si esta seleccionado
                            $("#brands_list").append
                                ($('<option selected></option>').val(brands.FirmCode).html(brands.FirmName));


                        } else {
                            $("#brands_list").append
                                ($('<option></option>').val(brands.FirmCode).html(brands.FirmName));
                        }
                        

                    }

                    )
                    getProductsline();
                },
                error: function () {
                    alert("Whooaaa! Something went wrong..")
                },
            });



    }


    function getProductsline() {
        var brandId = $("#brands_list").val();
        var idvisita = "";
        idvisita = document.getElementById('idvisita').value;

        $.ajax
            ({
                url: '/FormsM/Getproductline',
                type: 'POST',
                datatype: 'application/json',
                contentType: 'application/json',
                data: JSON.stringify({
                    brandID: brandId,
                    idvisit: idvisita
                }),
                success: function (result) {

                    $("#productline_list").html("");
                    $("#productline_list").append($('<option></option>').val(0).html("Seleccione una linea de producto"))
                    $.each($.parseJSON(result), function (i, productline) {

                        if (productline.isselected) {//si esta seleccionado
                            $("#productline_list").append
                                ($('<option selected></option>').val(productline.Id_subcategory).html(productline.SubCategory));

                        } else {
                            $("#productline_list").append
                                ($('<option></option>').val(productline.Id_subcategory).html(productline.SubCategory));
                        }
                    }
                    )

                },
                error: function () {
                    alert("Whooaaa! Something went wrong..")
                },
            });

    }
</script>

<script type="text/javascript">
    $(document).ready(function () {

    });

</script>
<!--SCRIPT FORM_TEMPLATE SAVE-->
<script>
    (function ($) {
        showSuccessToast = function () {
            'use strict';
            resetToastPosition();
            $.toast({
                heading: 'Success',
                text: 'Data saved.',
                showHideTransition: 'slide',
                icon: 'success',
                loaderBg: '#f96868',
                position: 'top-right'
            })
        };

        showWarning2Toast = function () {
            'use strict';
            resetToastPosition();
            $.toast({
                heading: 'Warning',
                text: 'Something wrong happened, try again.',
                showHideTransition: 'slide',
                icon: 'warning',
                loaderBg: '#ff9900',
                position: 'top-right'
            })
        };

        resetToastPosition = function () {
            $('.jq-toast-wrap').removeClass('bottom-left bottom-right top-left top-right mid-center'); // to remove previous position class
            $(".jq-toast-wrap").css({
                "top": "",
                "left": "",
                "bottom": "",
                "right": ""
            }); //to remove previous position style
        }
    })(jQuery);


    $(function () {
        $("#save_activity").click(function () {

            initGeolocation();

        }
        );
    });
    var options = {
        enableHighAccuracy: true,
        timeout: 5000,
        maximumAge: 0
    };

    function success(pos) {
        var crd = pos.coords;


        var lat = crd.latitude;
        var lng = crd.longitude;

        var idvisita = "";
        idvisita = document.getElementById('idvisita').value;


        //GUARDAMOS OBJETOS

        var objects = [];

        $.each($('input.form-control[type = "text"]'), function () {

            //alert("ID:" + $(this).attr('id') + "value: " + $(this).val());

            objects.push({
                id: $(this).attr('id'),
                value: $(this).val(),
                text: ""
            });


        });

        $.each($('input.form-control[type = "number"]'), function () {

            
            objects.push({
                id: $(this).attr('id'),
                value: $(this).val(),
                text: ""
            });


        });

        $.each($('input.form-check-input[type = "radio"]'), function () {


            objects.push({
                id: $(this).attr('id'),
                value: $(this).prop('checked'),
                text:""
            });


        });
        $.each($('input.form-check-input[type = "checkbox"]'), function () {


            objects.push({
                id: $(this).attr('id'),
                value: $(this).prop('checked'),
                text:""
            });


        });

        $.each($('input.dropifyIMG[type = "file"]'), function () { 
           
                    objects.push({
                        id: $(this).attr('id'),
                        value: $(this).attr('data-changeflag'),
                        text: ""
                    });

            });
           


        $.each($('textarea.form-control'), function () {

            //alert("ID:" + $(this).attr('id') + "value: " + $(this).val());

            objects.push({
                id: $(this).attr('id'),
                value: $(this).val(),
                text:""
            });


        });

        $.each($('select'), function () {

            //alert("ID:" + $(this).attr('id') + "value: " + $(this).val());
            var str = $(this).find('option:selected').text();
              str = str.substring(str.indexOf("-")+1);

            var final = "";
            objects.push({
                id: $(this).attr('name'),
                value: $(this).val(),
                text: str.trim()
            });


        });
  
        //var canvas = document.getElementById("sig-canvas");
        $.each($('canvas'), function () {
            var canvas = document.getElementById($(this).attr("id"));
            var dataUrl = canvas.toDataURL();
            //alert(dataUrl);

            objects.push({
                id: $(this).attr("data-id"),
                value: dataUrl,
                text:""
            });
        });


        //$.each(objects, function (propName, propVal) {
        //    console.log(propName, propVal);
        //});

        
        $.ajax({
            url: '/FormsM/Save_activity',
            type: 'POST',
            data: {'id': idvisita,'objects': objects,'lat':lat,'lng':lng },
            cache: false,
            global: false,
            success: function (result) {

                if (result.Result == "Success") {
                    showSuccessToast();

                    //var x = document.getElementById("finish_activity");
                    //if (x.style.display === "none") {
                    //    x.style.display = "inline-block";
                    //} else {
                    //    //x.style.display = "none";
                    //}

                    window.location.reload(true);
                //window.location.reload(true);
                } else {
                    showWarning2Toast();
                }


            },
            error: function (request) {
                showWarning2Toast();

            }
        });




    };

    function error(err) {
        console.warn('ERROR(' + err.code + '): ' + err.message);

        var idvisita = "";
        idvisita = document.getElementById('idvisita').value;


        //GUARDAMOS OBJETOS

        var objects = [];

        $.each($('input.form-control[type = "text"]'), function () {

            //alert("ID:" + $(this).attr('id') + "value: " + $(this).val());

            objects.push({
                id: $(this).attr('id'),
                value: $(this).val(),
                text: ""
            });


        });

        $.each($('input.form-control[type = "number"]'), function () {


            objects.push({
                id: $(this).attr('id'),
                value: $(this).val(),
                text: ""
            });


        });

        $.each($('input.form-check-input[type = "radio"]'), function () {


            objects.push({
                id: $(this).attr('id'),
                value: $(this).prop('checked'),
                text: ""
            });


        });
        $.each($('input.form-check-input[type = "checkbox"]'), function () {


            objects.push({
                id: $(this).attr('id'),
                value: $(this).prop('checked'),
                text: ""
            });


        });
        $.each($('textarea.form-control'), function () {

            //alert("ID:" + $(this).attr('id') + "value: " + $(this).val());

            objects.push({
                id: $(this).attr('id'),
                value: $(this).val(),
                text: ""
            });


        });

        $.each($('select'), function () {

            //alert("ID:" + $(this).attr('id') + "value: " + $(this).val());
            var str = $(this).find('option:selected').text();
            str = str.substring(str.indexOf("-") + 1);

            var final = "";
            objects.push({
                id: $(this).attr('name'),
                value: $(this).val(),
                text: str.trim()
            });


        });

        //var canvas = document.getElementById("sig-canvas");
        $.each($('canvas'), function () {
            var canvas = document.getElementById($(this).attr("id"));
            var dataUrl = canvas.toDataURL();
            //alert(dataUrl);

            objects.push({
                id: $(this).attr("data-id"),
                value: dataUrl,
                text: ""
            });
        });

        $.each($('input.dropifyIMG[type = "file"]'), function () {

            objects.push({
                id: $(this).attr('id'),
                value: $(this).attr('data-changeflag'),
                text: ""
            });

        });
        //$.each(objects, function (propName, propVal) {
        //    console.log(propName, propVal);
        //});


        $.ajax({
            url: '/FormsM/Save_activity',
            type: 'POST',
            data: { 'id': idvisita, 'objects': objects, 'lat': lat, 'lng': lng },
            cache: false,
            global: false,
            success: function (result) {

                if (result.Result == "Success") {
                    showSuccessToast();

                    ////var x = document.getElementById("finish_activity");
                    ////if (x.style.display === "none") {
                    ////    x.style.display = "inline-block";
                    ////} else {
                    ////    x.style.display = "none";
                    ////}
                    window.location.reload(true);

                    //window.location.reload(true);
                } else {
                    showWarning2Toast();
                }


            },
            error: function (request) {
                showWarning2Toast();

            }
        });
    };

    function initGeolocation() {
        if (navigator && navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(success, error, options);
        } else {
            console.log('Geolocation is not supported');
        }
    }
</script>

<!--FORM TEMPLATE FINISH-->
<script>

    $(function () {
        $("#finish_activity").click(function () {

            var now = new Date();
            // var MS_PER_MINUTE = 60000;
            //var offset = new Date().getTimezoneOffset();

            //var date = new Date(now - offset * MS_PER_MINUTE);
            //var localDate = new Date($(this).html());

            //console.log(now);
            console.log(now.toLocaleString());
            console.log(now.toLocaleString("en-US", { hour12: true }));



            var idvisita = "";
            idvisita = document.getElementById('idvisita').value;





            $.ajax({
                url: '/FormsM/Finish_activity',
                type: 'POST',
                data: '{"id":"' + idvisita + '"}',
                contentType: 'application/json; charset=utf-8',
                async: true,
                cache: false,
                global: false,
                complete: function () {

                },
                success: function (result) {
                    showSuccessToast();
                    window.location.reload(true);

                },
                error: function (request) {


                    window.location.reload(true);
                }
            });

        }
        );
    });//end

    $(document).on("click", '.dropify-clear', function () {

        var imgdiv = $(this).prev();

        var drevent = $(imgdiv).dropify();
     
        //Cambiamos el estado para verificar si se removio y si se mantiene en 100 entonces no se selecciono nada luego
        //con esto validamos cuando no han cargado nada al server, suben una pero luego la quitaan y como no actualizaba
        //el sistema no borraba la foto
        $(imgdiv).attr('data-changeflag', '100');

    });


</script>
<!--SCRIPT PARA GUARDAR IMAGENES TIEMPO REAL -->
<script>
    $('input[type=file]').change(function () {
        //Le decimos que por cada input file que encuentre hara este proceso
        // Checking whether FormData is available in browser
        if (window.FormData !== undefined) {
            //$.each($('input[type="file"]'), function () {
             
            var ID = $(this).attr('id');
         
            $(this).attr('data-changeflag', '0');

                var idvisita = "";
             

                var fileUpload = $("#" + ID).get(0);

                var files = fileUpload.files;
                
                // Create FormData object
                var fileData = new FormData();

                // Looping over all files and add it to FormData object
                for (var i = 0; i < files.length; i++) {
                    fileData.append(files[i].name, files[i]);
                }

                // Adding one more key to FormData object
                fileData.append('id', ID);
                fileData.append('idvisita', idvisita);
                

                
                //$.ajax({
                //    url: '/FormsM/UploadFiles',
                //    type: "POST",
                //    contentType: false, // Not to set any content header
                //    processData: false, // Not to process data
                //    async: true,
                //    timeout: 80000,
                //    data: fileData,
                //    success: function (result) {
                //        //$("#modal_demoform_saving").modal('hide');
                //    },
                //    error: function (err) {
                //        //$("#modal_demoform_saving").modal('hide');
                //        alert("An error is reported.");

                //    }
                //});
            //});


        }


        else {
            alert("FormData is not supported.");
        }

    });


</script>
<script>
    (function ($) {
        $.fn.currencyInput = function () {
            this.each(function () {
                var wrapper = $("<div class='currency-input' />");
                $(this).wrap(wrapper);
                $(this).before("<span class='currency-symbol'>$</span>");
                $(this).change(function () {
                    var min = parseFloat($(this).attr("min"));
                    var max = parseFloat($(this).attr("max"));
                    var value = this.valueAsNumber;
                    if (value < min)
                        value = min;
                    else if (value > max)
                        value = max;
                    $(this).val(value.toFixed(2));
                });
            });
        };
    })(jQuery);

    $(document).ready(function () {
        $('input.currency').currencyInput();
    });

</script>
