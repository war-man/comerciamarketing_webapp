
@{
    Layout = null;
}

<script type="text/javascript">
    window.onload = function () {
        //PARA RADIO BUTTONS
        $('.parentdiv').on('change', '.rad', function () {

            var id = $(this).attr('id');
            var parent = $(this).attr('name');



            if ($(this).is(':checked')) {
                $('.childdiv' + parent).hide();
                $('#radiodiv_' + id).show();
            } else {

            }
        });

        $('.parentdiv').on('change', '.chk', function () {

            var id = $(this).attr('id');
            var parent = $(this).attr('name');



            if ($(this).is(':checked')) {

                $('#radiodiv_' + id).show();
            } else {
                $('#radiodiv_' + id).hide();
            }
        });




    };


    function getBrands() {
        var customerId = $("#customer_list").val();
        var idvisita = "";
        idvisita = document.getElementById('idvisita').value;

        var lstbrands = @Html.Raw(ViewBag.lstbrands);
        var resultado = lstbrands.filter(item => item.Customer === customerId);

        var retrievedArrayF = JSON.parse(localStorage.getItem('FormsM_details'));
        //Filtramos por actividad
        var seleccionado = retrievedArrayF.filter(item => item.ID_visit === idvisita);
        var seleccionadofinal = retrievedArrayF.filter(item => item.id_resource === 13);

        var idsel;
        seleccionadofinal.forEach(function (objeto) {
            if (objeto.ID_visit == idvisita && objeto.id_resource == "13") {
                idsel = objeto.fvalueText;
            }
        });


        $("#brands_list").html("");
        $("#brands_list").append($('<option></option>').val(0).html("Select a Brand"))

        resultado.forEach(function (objeto) {
            if (objeto.FirmCode == idsel) {//si esta seleccionado
                $("#brands_list").append
                    ($('<option selected></option>').val(objeto.FirmCode).html(objeto.FirmName));
            } else {
                $("#brands_list").append
                    ($('<option></option>').val(objeto.FirmCode).html(objeto.FirmName));
            }
        });


        getProductsline();
    }


    function getProductsline() {
        var brandId = $("#brands_list").val();
        var idvisita = "";
        idvisita = document.getElementById('idvisita').value;

        var lstproductline = @Html.Raw(ViewBag.lstproductline);
        var resultado = lstproductline.filter(item => item.Brand === brandId);

        var retrievedArrayF = JSON.parse(localStorage.getItem('FormsM_details'));
        //Filtramos por actividad
        var seleccionado = retrievedArrayF.filter(item => item.ID_visit === idvisita);
        var seleccionadofinal = retrievedArrayF.filter(item => item.id_resource === 14);

        var idsel;
        seleccionadofinal.forEach(function (objeto) {
            if (objeto.ID_visit == idvisita && objeto.id_resource == "14") {
                idsel = objeto.fvalueText;
            }
        });

        $("#productline_list").html("");
        $("#productline_list").append($('<option></option>').val(0).html("Select a Product Line"));

        resultado.forEach(function (objeto) {
            if (objeto.Id_subcategory == idsel) {//si esta seleccionado
                $("#productline_list").append
                    ($('<option selected></option>').val(objeto.Id_subcategory).html(objeto.SubCategory));
            } else {
                $("#productline_list").append
                    ($('<option></option>').val(objeto.Id_subcategory).html(objeto.SubCategory));
            }
        });
        getBrandcompetitor();


    }

    function getBrandcompetitor() {
        var brandId = $("#brands_list").val();
        var idvisita = "";
        idvisita = document.getElementById('idvisita').value;

        var lstbcompetitor = @Html.Raw(ViewBag.lstbcompetitors);
        var resultado = lstbcompetitor.filter(item => item.Brand === brandId);

        var retrievedArrayF = JSON.parse(localStorage.getItem('FormsM_details'));
        //Filtramos por actividad
        var seleccionado = retrievedArrayF.filter(item => item.ID_visit === idvisita);
        var seleccionadofinal = retrievedArrayF.filter(item => item.id_resource === 15);

        var idsel;
        seleccionadofinal.forEach(function (objeto) {
            if (objeto.ID_visit == idvisita && objeto.id_resource == "15") {
                idsel = objeto.fvalueText;
            }
        });

        $("#brandcompetitors_list").html("");
        $("#brandcompetitors_list").append($('<option></option>').val(0).html("Select a Brand Competitor"));
        $("#brandcompetitors_list").append($('<option></option>').val('NA001').html("NOT ASSIGNED"));

        resultado.forEach(function (objeto) {
            if (objeto.Id_brandc == idsel) {//si esta seleccionado
                $("#brandcompetitors_list").append
                    ($('<option selected></option>').val(objeto.Id_brandc).html(objeto.namec));
            } else {
                $("#brandcompetitors_list").append
                    ($('<option></option>').val(objeto.Id_brandc).html(objeto.namec));
            }
        });
    }
</script>

<script type="text/javascript">
    $(document).ready(function () {

        //// Here we'll persist the form's data into localStorage on
        //// every keystroke
        //$(function () {
        //    $("#demoTform").sisyphus();
        //// or you can persist all forms data at one command
        //// $( "form" ).sisyphus();
        //});

    });

</script>
<!--SCRIPT FORM_TEMPLATE SAVE-->
<script>
    (function ($) {
        showSuccessToast2 = function () {
            'use strict';
            resetToastPosition();
            $.toast({
                heading: 'Success',
                text: 'Data saved.',
                loader: false,
                showHideTransition: 'slide',
                icon: 'success',
                loaderBg: '#f96868',
                position: 'top-right'
            })
        };

        showWarning2Toast = function () {
            'use strict';
            resetToastPosition();
            $.toast({
                heading: 'Warning',
                text: 'Something wrong happened, try again.',
                showHideTransition: 'slide',
                icon: 'warning',
                loaderBg: '#ff9900',
                position: 'top-right'
            })
        };

        resetToastPosition = function () {
            $('.jq-toast-wrap').removeClass('bottom-left bottom-right top-left top-right mid-center'); // to remove previous position class
            $(".jq-toast-wrap").css({
                "top": "",
                "left": "",
                "bottom": "",
                "right": ""
            }); //to remove previous position style
        }
    })(jQuery);

    function isOnLine() {
        return navigator.onLine;
    }
    $(function () {
        $("#save_activity").click(function () {

            initGeolocation();

        }
        );
    });
    var options = {
        enableHighAccuracy: true,
        timeout: 5000,
        maximumAge: 0
    };

    function success(pos) {
        var crd = pos.coords;
        $("#loading").show();

        var lat = crd.latitude;
        var lng = crd.longitude;

        var idvisita = "";
        idvisita = document.getElementById('idvisita').value;


        //GUARDAMOS OBJETOS

        var objects = [];


        $.each($('input.form-check-input[type = "checkbox"]'), function () {


            objects.push({
                id: $(this).attr('id'),
                value: $(this).prop('checked'),
                text: ""
            });


        });

        $.each($('input.dropifyIMG[type = "file"]'), function () {

            objects.push({
                id: $(this).attr('id'),
                value: $(this).attr('data-changeflag'),
                text: ""
            });

        });




        //var canvas = document.getElementById("sig-canvas");
        $.each($('canvas'), function () {
            var canvas = document.getElementById($(this).attr("id"));
            var dataUrl = canvas.toDataURL();
            //alert(dataUrl);

            objects.push({
                id: $(this).attr("data-id"),
                value: dataUrl,
                text: ""
            });
        });


        if (isOnLine()) {
                //En toda accion de guardar, primero siempre ira al localstorage como update y luego al server
            //Guardamos en local
            var retrievedArrayF = JSON.parse(localStorage.getItem('FormsM_details'));
            //filtramos por actividad ((NO SE PUEDE FILTRAR PORQUE SINO, BORRAMOS TODO EL CACHE AL SOBREESCRIBIRLO))
             //= retrievedArrayfi.filter(item => item.ID_visit === idVisita);

            var idVisita;
            try {
                idVisita = @ViewBag.idvisita;
            } catch{
                idVisita = "@ViewBag.idvisita";

            }          
            if (idVisita == "copy") {
                idVisita = getCookie("IDactivitycopy");
            }
            var item;

            //Creamos un metodo diferente para recorrer los elementos ya que hay objetos child
            //los cuales no se pueden solo mandar a llamar, sino que hay que recorrerlos
            function deepSearch(container, idkey, value, text) {

                for (var i = 0; i < container.length; i++) {
                    var objeto = container[i];
                    if (idVisita.toString().length > 4) {
                        if (idVisita.toString().substring(0, 4) == "copy") {//ES COPIA
                            if (objeto.query2 == idVisita && objeto.idkey == idkey) {
                                //Lo encontro en los parent y actualizaremos
                                item = objeto;
                                //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                                item.onserver = false;
                                if (objeto.resourcetype == 9) {//Si es firma
                                    if (value == "" || value == null) { value = ""; }
                                    item.fsource = value; //Lo guardamos

                                } else if (objeto.resourcetype == 16) {
                                    if (value == "" || value == null) { value = false; }
                                    item.fvalue = value; //Lo guardamos
                                }
                                break;
                            } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                                if (objeto.children.length > 0) {
                                    deepSearch(objeto.children, idkey, value, text);
                                }
                            }
                        } else { //NO ES COPIA
                            if (objeto.ID_visit == idVisita && objeto.idkey == idkey) {
                                //Lo encontro en los parent y actualizaremos
                                item = objeto;
                                //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                                item.onserver = false;
                                if (objeto.resourcetype == 9) {//Si es firma
                                    if (value == "" || value == null) { value = ""; }
                                    item.fsource = value; //Lo guardamos

                                } else if (objeto.resourcetype == 16) {
                                    if (value == "" || value == null) { value = false; }
                                    item.fvalue = value; //Lo guardamos
                                }
                                break;
                            } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                                if (objeto.children.length > 0) {
                                    deepSearch(objeto.children, idkey, value, text);
                                }
                            }
                        }

                    } else { //NO ES COPIA
                        if (objeto.ID_visit == idVisita && objeto.idkey == idkey) {
                            //Lo encontro en los parent y actualizaremos
                            item = objeto;
                            //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                            item.onserver = false;
                            if (objeto.resourcetype == 9) {//Si es firma
                                if (value == "" || value == null) { value = ""; }
                                item.fsource = value; //Lo guardamos

                            } else if (objeto.resourcetype == 16) {
                                if (value == "" || value == null) { value = false; }
                                item.fvalue = value; //Lo guardamos
                            }
                            break;
                        } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                            if (objeto.children.length > 0) {
                                deepSearch(objeto.children, idkey, value, text);
                            }
                        }
                    }



                }

            }

            objects.forEach(function (element) {
                var id = element.id;
                var val = element.value;
                var txt = element.text;
                deepSearch(retrievedArrayF, id, val, txt);
            });

            localStorage.setItem('FormsM_details', JSON.stringify(retrievedArrayF));

            var now = new Date();
            var retrievedArrayA = JSON.parse(localStorage.getItem('activities'));
            retrievedArrayA.forEach(function (objeto) {
                if (idVisita.toString().length > 4) {
                    if (idVisita.toString().substring(0, 4) == "copy") {//ES COPIA
                        if (objeto.query1 == idVisita) {
                            item = objeto;
                            //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                            item.onserver = false;
                            item.action = "update"
                            item.check_in = now.toLocaleString("en-US", { hour12: true });
                        }
                    } else { //NO ES COPIA
                        if (objeto.ID_activity == idVisita) {
                            item = objeto;
                            //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                            item.onserver = false;
                            item.action = "update"
                            item.check_in = now.toLocaleString("en-US", { hour12: true });
                        }
                    }

                } else { //NO ES COPIA
                    if (objeto.ID_activity == idVisita) {
                        item = objeto;
                        //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                        item.onserver = false;
                        item.action = "update"
                        item.check_in = now.toLocaleString("en-US", { hour12: true });
                    }
                }



            });
            localStorage.setItem('activities', JSON.stringify(retrievedArrayA));


            //Guardamos en server

            $.ajax({
                url: '/FormsM/Save_activity',
                type: 'POST',
                data: { 'id': idVisita, 'objects': objects, 'lat': lat, 'lng': lng, 'check_in': now.toLocaleString("en-US", { hour12: true }) },
                cache: false,
                global: false,
                success: function (result) {

                    if (result.Result == "Success") {
                        $("#loading").hide();
                                    //Guardamos en local
            var retrievedArrayF = JSON.parse(localStorage.getItem('FormsM_details'));
            //filtramos por actividad ((NO SE PUEDE FILTRAR PORQUE SINO, BORRAMOS TODO EL CACHE AL SOBREESCRIBIRLO))
             //= retrievedArrayfi.filter(item => item.ID_visit === idVisita);


            var item;

            //Creamos un metodo diferente para recorrer los elementos ya que hay objetos child
            //los cuales no se pueden solo mandar a llamar, sino que hay que recorrerlos
            function deepSearch(container, idkey, value, text) {

                for (var i = 0; i < container.length; i++) {
                    var objeto = container[i];
                    if (idVisita.toString().length > 4) {
                        if (idVisita.toString().substring(0, 4) == "copy") {//ES COPIA
                            if (objeto.query2 == idVisita && objeto.idkey == idkey) {
                                //Lo encontro en los parent y actualizaremos
                                item = objeto;
                                //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                                item.onserver = false;
                                item.action = "saved"

                                break;
                            } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                                if (objeto.children.length > 0) {
                                    deepSearch(objeto.children, idkey, value, text);
                                }
                            }
                        } else { //NO ES COPIA
                            if (objeto.ID_visit == idVisita && objeto.idkey == idkey) {
                                //Lo encontro en los parent y actualizaremos
                                item = objeto;
                                //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                                item.onserver = false;
                                item.action = "saved"

                                break;
                            } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                                if (objeto.children.length > 0) {
                                    deepSearch(objeto.children, idkey, value, text);
                                }
                            }
                        }

                    } else { //NO ES COPIA
                        if (objeto.ID_visit == idVisita && objeto.idkey == idkey) {
                            //Lo encontro en los parent y actualizaremos
                            item = objeto;
                            //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                            item.onserver = false;
                            item.action = "saved"

                            break;
                        } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                            if (objeto.children.length > 0) {
                                deepSearch(objeto.children, idkey, value, text);
                            }
                        }
                    }



                }

            }

            objects.forEach(function (element) {
                var id = element.id;
                var val = element.value;
                var txt = element.text;
                deepSearch(retrievedArrayF, id, val, txt);
            });

            localStorage.setItem('FormsM_details', JSON.stringify(retrievedArrayF));

                        var now = new Date();
                        var retrievedArrayA = JSON.parse(localStorage.getItem('activities'));
                        retrievedArrayA.forEach(function (objeto) {
                            if (idVisita.toString().length > 4) {
                                if (idVisita.toString().substring(0, 4) == "copy") {//ES COPIA
                                    if (objeto.query1 == idVisita) {
                                        item = objeto;
                                        //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                                        item.onserver = false;
                                        item.action = "saved"
                                        item.check_in = now.toLocaleString("en-US", { hour12: true });
                                    }
                                } else { //NO ES COPIA
                                    if (objeto.ID_activity == idVisita) {
                                        item = objeto;
                                        //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                                        item.onserver = false;
                                        item.action = "saved"
                                        item.check_in = now.toLocaleString("en-US", { hour12: true });
                                    }
                                }

                            } else { //NO ES COPIA
                                if (objeto.ID_activity == idVisita) {
                                    item = objeto;
                                    //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                                    item.onserver = false;
                                    item.action = "saved"
                                    item.check_in = now.toLocaleString("en-US", { hour12: true });
                                }
                            }



                        });
                        localStorage.setItem('activities', JSON.stringify(retrievedArrayA));

                        showSuccessToast();

                        var x = document.getElementById("finish_activity");
                        if (x.style.display === "none") {
                            x.style.display = "inline-block";
                        } else {
                            x.style.display = "none";
                        }
                        //window.location.reload(true);

                        //window.location.reload(true);
                    } else {
                        $("#loading").hide();
                        showWarning2Toast();

                    }


                },
                error: function (request) {
                    $("#loading").hide();
                    showWarning2Toast();

                }
            });
        } else {  //OFFLINE
                //En toda accion de guardar, primero siempre ira al localstorage como update y luego al server
            //Guardamos en local
            var retrievedArrayF = JSON.parse(localStorage.getItem('FormsM_details'));
            //filtramos por actividad ((NO SE PUEDE FILTRAR PORQUE SINO, BORRAMOS TODO EL CACHE AL SOBREESCRIBIRLO))
             //= retrievedArrayfi.filter(item => item.ID_visit === idVisita);

            var idVisita;
            try {
                idVisita = @ViewBag.idvisita;
            } catch{
                idVisita = "@ViewBag.idvisita";

            }          
            if (idVisita == "copy") {
                idVisita = getCookie("IDactivitycopy");
            }
            var item;

            //Creamos un metodo diferente para recorrer los elementos ya que hay objetos child
            //los cuales no se pueden solo mandar a llamar, sino que hay que recorrerlos
            function deepSearch(container, idkey, value, text) {

                for (var i = 0; i < container.length; i++) {
                    var objeto = container[i];
                    if (idVisita.toString().length > 4) {
                        if (idVisita.toString().substring(0, 4) == "copy") {//ES COPIA
                            if (objeto.query2 == idVisita && objeto.idkey == idkey) {
                                //Lo encontro en los parent y actualizaremos
                                item = objeto;
                                //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                                item.onserver = false;
                                if (objeto.resourcetype == 9) {//Si es firma
                                    if (value == "" || value == null) { value = ""; }
                                    item.fsource = value; //Lo guardamos

                                } else if (objeto.resourcetype == 16) {
                                    if (value == "" || value == null) { value = false; }
                                    item.fvalue = value; //Lo guardamos
                                }
                                break;
                            } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                                if (objeto.children.length > 0) {
                                    deepSearch(objeto.children, idkey, value, text);
                                }
                            }
                        } else { //NO ES COPIA
                            if (objeto.ID_visit == idVisita && objeto.idkey == idkey) {
                                //Lo encontro en los parent y actualizaremos
                                item = objeto;
                                //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                                item.onserver = false;
                                if (objeto.resourcetype == 9) {//Si es firma
                                    if (value == "" || value == null) { value = ""; }
                                    item.fsource = value; //Lo guardamos

                                } else if (objeto.resourcetype == 16) {
                                    if (value == "" || value == null) { value = false; }
                                    item.fvalue = value; //Lo guardamos
                                }
                                break;
                            } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                                if (objeto.children.length > 0) {
                                    deepSearch(objeto.children, idkey, value, text);
                                }
                            }
                        }

                    } else { //NO ES COPIA
                        if (objeto.ID_visit == idVisita && objeto.idkey == idkey) {
                            //Lo encontro en los parent y actualizaremos
                            item = objeto;
                            //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                            item.onserver = false;
                            if (objeto.resourcetype == 9) {//Si es firma
                                if (value == "" || value == null) { value = ""; }
                                item.fsource = value; //Lo guardamos

                            } else if (objeto.resourcetype == 16) {
                                if (value == "" || value == null) { value = false; }
                                item.fvalue = value; //Lo guardamos
                            }
                            break;
                        } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                            if (objeto.children.length > 0) {
                                deepSearch(objeto.children, idkey, value, text);
                            }
                        }
                    }



                }

            }

            objects.forEach(function (element) {
                var id = element.id;
                var val = element.value;
                var txt = element.text;
                deepSearch(retrievedArrayF, id, val, txt);
            });

            localStorage.setItem('FormsM_details', JSON.stringify(retrievedArrayF));

            var now = new Date();
            var retrievedArrayA = JSON.parse(localStorage.getItem('activities'));
            retrievedArrayA.forEach(function (objeto) {
                if (idVisita.toString().length > 4) {
                    if (idVisita.toString().substring(0, 4) == "copy") {//ES COPIA

                        if (objeto.query1 == idVisita) {
                            item = objeto;
                            //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                            item.onserver = false;
                            item.action = "update"
                            item.check_in = now.toLocaleString("en-US", { hour12: true });
                        }
                    } else { //NO ES COPIA

                        if (objeto.ID_activity == idVisita) {
                            item = objeto;
                            //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                            item.onserver = false;
                            item.action = "update"
                            item.check_in = now.toLocaleString("en-US", { hour12: true });
                        }
                    }

                } else { //NO ES COPIA

                    if (objeto.ID_activity == idVisita) {
                        item = objeto;
                        //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                        item.onserver = false;
                        item.action = "update"
                        item.check_in = now.toLocaleString("en-US", { hour12: true });
                    }
                }


            });
            localStorage.setItem('activities', JSON.stringify(retrievedArrayA));

            $("#loading").hide();
            showSuccessToast();

            var x = document.getElementById("finish_activity");
            if (x.style.display === "none") {
                x.style.display = "inline-block";
            } else {
                x.style.display = "none";
            }

        }



    };

    function error(err) {
        console.warn('ERROR(' + err.code + '): ' + err.message);
        $("#loading").show();
        var idvisita = "";
        idvisita = document.getElementById('idvisita').value;


        //GUARDAMOS OBJETOS

        var objects = [];


        $.each($('input.form-check-input[type = "checkbox"]'), function () {


            objects.push({
                id: $(this).attr('id'),
                value: $(this).prop('checked'),
                text: ""
            });


        });


        //var canvas = document.getElementById("sig-canvas");
        $.each($('canvas'), function () {
            var canvas = document.getElementById($(this).attr("id"));
            var dataUrl = canvas.toDataURL();
            //alert(dataUrl);

            objects.push({
                id: $(this).attr("data-id"),
                value: dataUrl,
                text: ""
            });
        });

        //$.each($('input.dropifyIMG[type = "file"]'), function () {

        //    objects.push({
        //        id: $(this).attr('id'),
        //        value: $(this).attr('data-changeflag'),
        //        text: ""
        //    });

        //});

        if (isOnLine()) {
                //En toda accion de guardar, primero siempre ira al localstorage como update y luego al server
            //Guardamos en local
            var retrievedArrayF = JSON.parse(localStorage.getItem('FormsM_details'));
            //filtramos por actividad ((NO SE PUEDE FILTRAR PORQUE SINO, BORRAMOS TODO EL CACHE AL SOBREESCRIBIRLO))
             //= retrievedArrayfi.filter(item => item.ID_visit === idVisita);

            var idVisita;
            try {
                idVisita = @ViewBag.idvisita;
            } catch{
                idVisita = "@ViewBag.idvisita";

            }          
            if (idVisita == "copy") {
                idVisita = getCookie("IDactivitycopy");
            }
            var item;

            //Creamos un metodo diferente para recorrer los elementos ya que hay objetos child
            //los cuales no se pueden solo mandar a llamar, sino que hay que recorrerlos
            function deepSearch(container, idkey, value, text) {

                for (var i = 0; i < container.length; i++) {
                    var objeto = container[i];
                    if (idVisita.toString().length > 4) {
                        if (idVisita.toString().substring(0, 4) == "copy") {//ES COPIA
                            if (objeto.query2 == idVisita && objeto.idkey == idkey) {
                                //Lo encontro en los parent y actualizaremos
                                item = objeto;
                                //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                                item.onserver = false;
                                if (objeto.resourcetype == 9) {//Si es firma
                                    if (value == "" || value == null) { value = ""; }
                                    item.fsource = value; //Lo guardamos

                                } else if (objeto.resourcetype == 16) {
                                    if (value == "" || value == null) { value = false; }
                                    item.fvalue = value; //Lo guardamos
                                }
                                break;
                            } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                                if (objeto.children.length > 0) {
                                    deepSearch(objeto.children, idkey, value, text);
                                }
                            }
                        } else { //NO ES COPIA
                            if (objeto.ID_visit == idVisita && objeto.idkey == idkey) {
                                //Lo encontro en los parent y actualizaremos
                                item = objeto;
                                //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                                item.onserver = false;
                                if (objeto.resourcetype == 9) {//Si es firma
                                    if (value == "" || value == null) { value = ""; }
                                    item.fsource = value; //Lo guardamos

                                } else if (objeto.resourcetype == 16) {
                                    if (value == "" || value == null) { value = false; }
                                    item.fvalue = value; //Lo guardamos
                                }
                                break;
                            } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                                if (objeto.children.length > 0) {
                                    deepSearch(objeto.children, idkey, value, text);
                                }
                            }
                        }

                    } else { //NO ES COPIA
                        if (objeto.ID_visit == idVisita && objeto.idkey == idkey) {
                            //Lo encontro en los parent y actualizaremos
                            item = objeto;
                            //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                            item.onserver = false;
                            if (objeto.resourcetype == 9) {//Si es firma
                                if (value == "" || value == null) { value = ""; }
                                item.fsource = value; //Lo guardamos

                            } else if (objeto.resourcetype == 16) {
                                if (value == "" || value == null) { value = false; }
                                item.fvalue = value; //Lo guardamos
                            }
                            break;
                        } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                            if (objeto.children.length > 0) {
                                deepSearch(objeto.children, idkey, value, text);
                            }
                        }
                    }



                }

            }

            objects.forEach(function (element) {
                var id = element.id;
                var val = element.value;
                var txt = element.text;
                deepSearch(retrievedArrayF, id, val, txt);
            });

            localStorage.setItem('FormsM_details', JSON.stringify(retrievedArrayF));

            var now = new Date();
            var retrievedArrayA = JSON.parse(localStorage.getItem('activities'));
            retrievedArrayA.forEach(function (objeto) {
                if (idVisita.toString().length > 4) {
                    if (idVisita.toString().substring(0, 4) == "copy") {//ES COPIA
                        if (objeto.query1 == idVisita) {
                            item = objeto;
                            //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                            item.onserver = false;
                            item.action = "update"
                            item.check_in = now.toLocaleString("en-US", { hour12: true });
                        }
                    } else { //NO ES COPIA
                        if (objeto.ID_activity == idVisita) {
                            item = objeto;
                            //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                            item.onserver = false;
                            item.action = "update"
                            item.check_in = now.toLocaleString("en-US", { hour12: true });
                        }
                    }

                } else { //NO ES COPIA
                    if (objeto.ID_activity == idVisita) {
                        item = objeto;
                        //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                        item.onserver = false;
                        item.action = "update"
                        item.check_in = now.toLocaleString("en-US", { hour12: true });
                    }
                }



            });
            localStorage.setItem('activities', JSON.stringify(retrievedArrayA));

            //Guardamos en server
            $.ajax({
                url: '/FormsM/Save_activity',
                type: 'POST',
                data: { 'id': idVisita, 'objects': objects, 'lat': "", 'lng': "", 'check_in': now.toLocaleString("en-US", { hour12: true }) },
                cache: false,
                global: false,
                success: function (result) {

                    if (result.Result == "Success") {
                        $("#loading").hide();
                                    //Guardamos en local
            var retrievedArrayF = JSON.parse(localStorage.getItem('FormsM_details'));
            //filtramos por actividad ((NO SE PUEDE FILTRAR PORQUE SINO, BORRAMOS TODO EL CACHE AL SOBREESCRIBIRLO))
             //= retrievedArrayfi.filter(item => item.ID_visit === idVisita);

            var item;

            //Creamos un metodo diferente para recorrer los elementos ya que hay objetos child
            //los cuales no se pueden solo mandar a llamar, sino que hay que recorrerlos
            function deepSearch(container, idkey, value, text) {

                for (var i = 0; i < container.length; i++) {
                    var objeto = container[i];
                    if (idVisita.toString().length > 4) {
                        if (idVisita.toString().substring(0, 4) == "copy") {//ES COPIA
                            if (objeto.query2 == idVisita && objeto.idkey == idkey) {
                                //Lo encontro en los parent y actualizaremos
                                item = objeto;
                                //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                                item.onserver = false;
                                item.action = "saved"

                                break;
                            } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                                if (objeto.children.length > 0) {
                                    deepSearch(objeto.children, idkey, value, text);
                                }
                            }
                        } else { //NO ES COPIA
                            if (objeto.ID_visit == idVisita && objeto.idkey == idkey) {
                                //Lo encontro en los parent y actualizaremos
                                item = objeto;
                                //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                                item.onserver = false;
                                item.action = "saved"

                                break;
                            } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                                if (objeto.children.length > 0) {
                                    deepSearch(objeto.children, idkey, value, text);
                                }
                            }
                        }

                    } else { //NO ES COPIA
                        if (objeto.ID_visit == idVisita && objeto.idkey == idkey) {
                            //Lo encontro en los parent y actualizaremos
                            item = objeto;
                            //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                            item.onserver = false;
                            item.action = "saved"

                            break;
                        } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                            if (objeto.children.length > 0) {
                                deepSearch(objeto.children, idkey, value, text);
                            }
                        }
                    }



                }

            }

            objects.forEach(function (element) {
                var id = element.id;
                var val = element.value;
                var txt = element.text;
                deepSearch(retrievedArrayF, id, val, txt);
            });

            localStorage.setItem('FormsM_details', JSON.stringify(retrievedArrayF));
                        var now = new Date();
                        var retrievedArrayA = JSON.parse(localStorage.getItem('activities'));
                        retrievedArrayA.forEach(function (objeto) {
                            if (idVisita.toString().length > 4) {
                                if (idVisita.toString().substring(0, 4) == "copy") {//ES COPIA
                                    if (objeto.query1 == idVisita) {
                                        item = objeto;
                                        //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                                        item.onserver = false;
                                        item.action = "saved"
                                        item.check_in = now.toLocaleString("en-US", { hour12: true });
                                    }
                                } else { //NO ES COPIA
                                    if (objeto.ID_activity == idVisita) {
                                        item = objeto;
                                        //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                                        item.onserver = false;
                                        item.action = "saved"
                                        item.check_in = now.toLocaleString("en-US", { hour12: true });
                                    }
                                }

                            } else { //NO ES COPIA
                                if (objeto.ID_activity == idVisita) {
                                    item = objeto;
                                    //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                                    item.onserver = false;
                                    item.action = "saved"
                                    item.check_in = now.toLocaleString("en-US", { hour12: true });
                                }
                            }



                        });
                        localStorage.setItem('activities', JSON.stringify(retrievedArrayA));

                        showSuccessToast();

                        var x = document.getElementById("finish_activity");
                        if (x.style.display === "none") {
                            x.style.display = "inline-block";
                        } else {
                            x.style.display = "none";
                        }
                        //window.location.reload(true);

                        //window.location.reload(true);
                    } else {
                        $("#loading").hide();
                        showWarning2Toast();

                    }


                },
                error: function (request) {
                    $("#loading").hide();
                    showWarning2Toast();

                }
            });
        } else { //OFFLINE
                //En toda accion de guardar, primero siempre ira al localstorage como update y luego al server
            //Guardamos en local
            var retrievedArrayF = JSON.parse(localStorage.getItem('FormsM_details'));
            //filtramos por actividad ((NO SE PUEDE FILTRAR PORQUE SINO, BORRAMOS TODO EL CACHE AL SOBREESCRIBIRLO))
             //= retrievedArrayfi.filter(item => item.ID_visit === idVisita);

            var idVisita;
            try {
                idVisita = @ViewBag.idvisita;
            } catch{
                idVisita = "@ViewBag.idvisita";

            }          
            if (idVisita == "copy") {
                idVisita = getCookie("IDactivitycopy");
            }
            var item;

            //Creamos un metodo diferente para recorrer los elementos ya que hay objetos child
            //los cuales no se pueden solo mandar a llamar, sino que hay que recorrerlos
            function deepSearch(container, idkey, value, text) {

                for (var i = 0; i < container.length; i++) {
                    var objeto = container[i];
                    if (idVisita.toString().length > 4) {
                        if (idVisita.toString().substring(0, 4) == "copy") {//ES COPIA
                            if (objeto.query2 == idVisita && objeto.idkey == idkey) {
                                //Lo encontro en los parent y actualizaremos
                                item = objeto;
                                //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                                item.onserver = false;
                                if (objeto.resourcetype == 9) {//Si es firma
                                    if (value == "" || value == null) { value = ""; }
                                    item.fsource = value; //Lo guardamos

                                } else if (objeto.resourcetype == 16) {
                                    if (value == "" || value == null) { value = false; }
                                    item.fvalue = value; //Lo guardamos
                                }
                                break;
                            } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                                if (objeto.children.length > 0) {
                                    deepSearch(objeto.children, idkey, value, text);
                                }
                            }
                        } else { //NO ES COPIA
                            if (objeto.ID_visit == idVisita && objeto.idkey == idkey) {
                                //Lo encontro en los parent y actualizaremos
                                item = objeto;
                                //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                                item.onserver = false;
                                if (objeto.resourcetype == 9) {//Si es firma
                                    if (value == "" || value == null) { value = ""; }
                                    item.fsource = value; //Lo guardamos

                                } else if (objeto.resourcetype == 16) {
                                    if (value == "" || value == null) { value = false; }
                                    item.fvalue = value; //Lo guardamos
                                }
                                break;
                            } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                                if (objeto.children.length > 0) {
                                    deepSearch(objeto.children, idkey, value, text);
                                }
                            }
                        }

                    } else { //NO ES COPIA
                        if (objeto.ID_visit == idVisita && objeto.idkey == idkey) {
                            //Lo encontro en los parent y actualizaremos
                            item = objeto;
                            //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                            item.onserver = false;
                            if (objeto.resourcetype == 9) {//Si es firma
                                if (value == "" || value == null) { value = ""; }
                                item.fsource = value; //Lo guardamos

                            } else if (objeto.resourcetype == 16) {
                                if (value == "" || value == null) { value = false; }
                                item.fvalue = value; //Lo guardamos
                            }
                            break;
                        } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                            if (objeto.children.length > 0) {
                                deepSearch(objeto.children, idkey, value, text);
                            }
                        }
                    }



                }

            }

            objects.forEach(function (element) {
                var id = element.id;
                var val = element.value;
                var txt = element.text;
                deepSearch(retrievedArrayF, id, val, txt);
            });

            localStorage.setItem('FormsM_details', JSON.stringify(retrievedArrayF));

            var now = new Date();
            var retrievedArrayA = JSON.parse(localStorage.getItem('activities'));
            retrievedArrayA.forEach(function (objeto) {
                if (idVisita.toString().length > 4) {
                    if (idVisita.toString().substring(0, 4) == "copy") {//ES COPIA
                        if (objeto.query1 == idVisita) {
                            item = objeto;
                            //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                            item.onserver = false;
                            item.action = "update"
                            item.check_in = now.toLocaleString("en-US", { hour12: true });
                        }
                    } else { //NO ES COPIA
                        if (objeto.ID_activity == idVisita) {
                            item = objeto;
                            //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                            item.onserver = false;
                            item.action = "update"
                            item.check_in = now.toLocaleString("en-US", { hour12: true });
                        }
                    }

                } else { //NO ES COPIA
                    if (objeto.ID_activity == idVisita) {
                        item = objeto;
                        //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                        item.onserver = false;
                        item.action = "update"
                        item.check_in = now.toLocaleString("en-US", { hour12: true });
                    }
                }



            });
            localStorage.setItem('activities', JSON.stringify(retrievedArrayA));

            $("#loading").hide();
            showSuccessToast();

            var x = document.getElementById("finish_activity");
            if (x.style.display === "none") {
                x.style.display = "inline-block";
            } else {
                x.style.display = "none";
            }

        }

    };

    function initGeolocation() {
        if (navigator && navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(success, error, options);
        } else {
            $("#loading").hide();
            console.log('Geolocation is not supported');
        }
    }
</script>

<!--FORM TEMPLATE FINISH-->
<script>

    $(function () {
        $("#finish_activity").click(function () {
            var flag = true;


            $.each($('input.form-control[type = "text"]'), function () {
                if ($(this).parent().closest('.parentdiv').prev().attr('class') == null) { //Si es un item independiente

                    if ($(this).val() == "" || $(this).val() == null) {
                        flag = false;
                        $(this).addClass("border-danger");
                    }
                    else {
                        $(this).removeClass("border-danger");
                    }

                } else if ($(this).parent().closest('.parentdiv').prev().attr('class') == "form-radio") {
                    if ($(this).parent().closest('.parentdiv').prev().find("input.form-check-input[type = 'radio']:checked").length <= 0) {
                        //Entonces no lo evaluamos para validacion ya que no han chequeado al parent
                    } else {
                        //Evaluamos para validacion ya que chequearon al padre
                        if ($(this).val() == "" || $(this).val() == null) {
                            flag = false;
                            $(this).addClass("border-danger");
                        } else {
                            $(this).removeClass("border-danger");
                        }
                    }
                } else if ($(this).parent().closest('.parentdiv').prev().attr('class') == "form-check") {
                    if ($(this).parent().closest('.parentdiv').prev().find("input.form-check-input[type = 'checkbox']:checked").length <= 0) {
                        //Entonces no lo evaluamos para validacion ya que no han chequeado al parent
                    } else {
                        //Evaluamos para validacion ya que chequearon al padre
                        if ($(this).val() == "" || $(this).val() == null) {
                            flag = false;
                            $(this).addClass("border-danger");
                        } else {
                            $(this).removeClass("border-danger");
                        }
                    }
                }
            });

            $.each($('input.form-control[type = "number"]'), function () {
                if ($(this).parent().closest('.parentdiv').prev().attr('class') == null) { //Si es un item independiente

                    if ($(this).val() == "" || $(this).val() == null) {
                        flag = false;
                        $(this).addClass("border-danger");
                    }
                    else {
                        $(this).removeClass("border-danger");
                    }

                } else if ($(this).parent().closest('.parentdiv').prev().attr('class') == "form-radio") {
                    if ($(this).parent().closest('.parentdiv').prev().find("input.form-check-input[type = 'radio']:checked").length <= 0) {
                        //Entonces no lo evaluamos para validacion ya que no han chequeado al parent
                    } else {
                        //Evaluamos para validacion ya que chequearon al padre
                        if ($(this).val() == "" || $(this).val() == null) {
                            flag = false;
                            $(this).addClass("border-danger");
                        } else {
                            $(this).removeClass("border-danger");
                        }
                    }
                } else if ($(this).parent().closest('.parentdiv').prev().attr('class') == "form-check") {
                    if ($(this).parent().closest('.parentdiv').prev().find("input.form-check-input[type = 'checkbox']:checked").length <= 0) {
                        //Entonces no lo evaluamos para validacion ya que no han chequeado al parent
                    } else {
                        //Evaluamos para validacion ya que chequearon al padre
                        if ($(this).val() == "" || $(this).val() == null) {
                            flag = false;
                            $(this).addClass("border-danger");
                        } else {
                            $(this).removeClass("border-danger");
                        }
                    }
                }
            });

            //$.each($('input.form-check-input[type = "radio"]'), function () {
            //    //Para seleccion unica que le siga otro seleccion unica
            //    if ($(this).is(":checked") && $(this).next().find("input.form-check-input[type = 'radio']").length > 0) {
            //        if ($(this).is(":checked") && $(this).next().find("input.form-check-input[type = 'radio']:checked").length <= 0) {
            //            flag = false;
            //        }
            //    }
            //    //Para seleccion unica que le siga uno de seleccion multiple
            //    if ($(this).is(":checked") && $(this).next().find("input.form-check-input[type = 'checkbox']").length > 0) {
            //        if ($(this).is(":checked") && $(this).next().find("input.form-check-input[type = 'radio']:checked").length <= 0) {
            //            flag = false;
            //        }
            //    }

            //});



            //$.each($('input.form-check-input[type = "checkbox"]'), function () {

            //});

            //$.each($('input.dropifyIMG[type = "file"]'), function () {

            //});



            $.each($('textarea.form-control'), function () {
                if ($(this).parent().closest('.parentdiv').prev().attr('class') == null) { //Si es un item independiente

                    if ($(this).val() == "" || $(this).val() == null) {
                        flag = false;
                        $(this).addClass("border-danger");
                    }
                    else {
                        $(this).removeClass("border-danger");
                    }

                } else if ($(this).parent().closest('.parentdiv').prev().attr('class') == "form-radio") {
                    if ($(this).parent().closest('.parentdiv').prev().find("input.form-check-input[type = 'radio']:checked").length <= 0) {
                        //Entonces no lo evaluamos para validacion ya que no han chequeado al parent
                    } else {
                        //Evaluamos para validacion ya que chequearon al padre
                        if ($(this).val() == "" || $(this).val() == null) {
                            flag = false;
                            $(this).addClass("border-danger");
                        } else {
                            $(this).removeClass("border-danger");
                        }
                    }
                } else if ($(this).parent().closest('.parentdiv').prev().attr('class') == "form-check") {
                    if ($(this).parent().closest('.parentdiv').prev().find("input.form-check-input[type = 'checkbox']:checked").length <= 0) {
                        //Entonces no lo evaluamos para validacion ya que no han chequeado al parent
                    } else {
                        //Evaluamos para validacion ya que chequearon al padre
                        if ($(this).val() == "" || $(this).val() == null) {
                            flag = false;
                            $(this).addClass("border-danger");
                        } else {
                            $(this).removeClass("border-danger");
                        }
                    }
                }




            });

            $.each($('select'), function () {
                if ($(this).parent().closest('.parentdiv').prev().attr('class') == null) { //Si es un item independiente

                    if ($(this).val() == "0" || $(this).val() == null) {
                        flag = false;
                        $(this).addClass("border-danger");
                    }
                    else {
                        $(this).removeClass("border-danger");
                    }

                } else if ($(this).parent().closest('.parentdiv').prev().attr('class') == "form-radio") {
                    if ($(this).parent().closest('.parentdiv').prev().find("input.form-check-input[type = 'radio']:checked").length <= 0) {
                        //Entonces no lo evaluamos para validacion ya que no han chequeado al parent
                    } else {
                        //Evaluamos para validacion ya que chequearon al padre
                        if ($(this).val() == "0" || $(this).val() == null) {
                            flag = false;
                            $(this).addClass("border-danger");
                        } else {
                            $(this).removeClass("border-danger");
                        }
                    }
                } else if ($(this).parent().closest('.parentdiv').prev().attr('class') == "form-check") {
                    if ($(this).parent().closest('.parentdiv').prev().find("input.form-check-input[type = 'checkbox']:checked").length <= 0) {
                        //Entonces no lo evaluamos para validacion ya que no han chequeado al parent
                    } else {
                        //Evaluamos para validacion ya que chequearon al padre
                        if ($(this).val() == "0" || $(this).val() == null) {
                            flag = false;
                            $(this).addClass("border-danger");
                        } else {
                            $(this).removeClass("border-danger");
                        }
                    }
                }


            });

            //var canvas = document.getElementById("sig-canvas");
            $.each($('canvas'), function () {

            });

            if (flag == true) {
                initGeolocation2();

            } else {
                $("#loading").hide();

                var x = document.getElementById("finish_activity");
                x.style.display = "none";
                //Alerta de que no se han guardado los campos obligatorios
                $.toast({
                    heading: 'Warning',
                    text: 'Please fill in all required fields (*) in this form',
                    loader: false,        // Change it to false to disable loader
                    showHideTransition: 'slide',
                    icon: 'warning',
                    loaderBg: '#ff9900',
                    hideAfter: 5000,
                    position: 'top-right'
                });







            }


        }
        );
    });//end

    $(document).on("click", '.dropify-clear', function () {

        var imgdiv = $(this).prev();

        var drevent = $(imgdiv).dropify();

        //Cambiamos el estado para verificar si se removio y si se mantiene en 100 entonces no se selecciono nada luego
        //con esto validamos cuando no han cargado nada al server, suben una pero luego la quitaan y como no actualizaba
        //el sistema no borraba la foto
        $(imgdiv).attr('data-changeflag', '100');

    });


</script>

<script>
    (function ($) {
        $.fn.currencyInput = function () {
            this.each(function () {
                var wrapper = $("<div class='currency-input' />");
                $(this).wrap(wrapper);
                $(this).before("<span class='currency-symbol'>$</span>");
                $(this).change(function () {
                    var min = parseFloat($(this).attr("min"));
                    var max = parseFloat($(this).attr("max"));
                    var value = this.valueAsNumber;
                    if (value < min)
                        value = min;
                    else if (value > max)
                        value = max;
                    $(this).val(value.toFixed(2));
                });
            });
        };
    })(jQuery);

    $(document).ready(function () {
        $('input.currency').currencyInput();
    });

</script>

<script>
    function isOnLine() {
        return navigator.onLine;
    }
//FINISH TEMPLATE
    var options2 = {
        enableHighAccuracy: true,
        timeout: 5000,
        maximumAge: 0
    };

    function success2(pos) {
        var crd = pos.coords;
        $("#loading").show();

        var lat = crd.latitude;
        var lng = crd.longitude;

            var idVisita;
            try {
                idVisita = @ViewBag.idvisita;
            } catch{
                idVisita = "@ViewBag.idvisita";

            }          
            if (idVisita == "copy") {
                idVisita = getCookie("IDactivitycopy");
            }
        if (isOnLine()) {
            var now = new Date();
            var retrievedArrayA = JSON.parse(localStorage.getItem('activities'));
            retrievedArrayA.forEach(function (objeto) {
                if (idVisita.toString().length > 4) {
                    if (idVisita.toString().substring(0, 4) == "copy") {//ES COPIA
                        if (objeto.query1 == idVisita) {
                            item = objeto;
                            //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                            item.onserver = false;
                            item.action = "update"
                            item.isfinished = true;
                            item.check_out = now.toLocaleString("en-US", { hour12: true });
                        }
                    } else { //NO ES COPIA

                        if (objeto.ID_activity == idVisita) {
                            item = objeto;
                            //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                            item.onserver = false;
                            item.action = "update"
                            item.isfinished = true;
                            item.check_out = now.toLocaleString("en-US", { hour12: true });
                        }
                    }

                } else { //NO ES COPIA

                    if (objeto.ID_activity == idVisita) {
                        item = objeto;
                        //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                        item.onserver = false;
                        item.action = "update"
                        item.isfinished = true;
                        item.check_out = now.toLocaleString("en-US", { hour12: true });
                    }
                }


            });
            localStorage.setItem('activities', JSON.stringify(retrievedArrayA));


        $.ajax({
            url: '/FormsM/Finish_activity',
            type: 'POST',
            data: { 'id': idVisita, 'lat': lat, 'lng': lng, 'check_out': now.toLocaleString("en-US", { hour12: true }) },
            complete: function () {

            },
            success: function (result) {

                 var url = '@Url.Action("Details", "VisitsMs", new {id= ViewBag.idvisitareal })';
                $("#loading").hide();


                var retrievedArrayA = JSON.parse(localStorage.getItem('activities'));
                retrievedArrayA.forEach(function (objeto) {
                    if (idVisita.toString().length > 4) {
                        if (idVisita.toString().substring(0, 4) == "copy") {//ES COPIA
                            if (objeto.query1 == idVisita) {
                                item = objeto;
                                //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                                item.onserver = false;
                                item.action = "saved"
                            }
                        } else { //NO ES COPIA
                            if (objeto.ID_activity == idVisita) {
                                item = objeto;
                                //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                                item.onserver = false;
                                item.action = "saved"
                            }
                        }

                    } else { //NO ES COPIA
                        if (objeto.ID_activity == idVisita) {
                            item = objeto;
                            //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                            item.onserver = false;
                            item.action = "saved"
                        }
                    }



                });
                localStorage.setItem('activities', JSON.stringify(retrievedArrayA));

                    window.location.href = url;

            },
            error: function (request) {

                $("#loading").hide();
                window.location.reload(true);
            }
        });

        } else {
            var now = new Date();
            var retrievedArrayA = JSON.parse(localStorage.getItem('activities'));
            retrievedArrayA.forEach(function (objeto) {
                if (idVisita.toString().length > 4) {
                    if (idVisita.toString().substring(0, 4) == "copy") {//ES COPIA
                        if (objeto.query1 == idVisita) {
                            item = objeto;
                            //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                            item.onserver = false;
                            item.action = "update"
                            item.isfinished = true;
                            item.check_out = now.toLocaleString("en-US", { hour12: true });
                        }
                    } else { //NO ES COPIA
                        if (objeto.ID_activity == idVisita) {
                            item = objeto;
                            //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                            item.onserver = false;
                            item.action = "update"
                            item.isfinished = true;
                            item.check_out = now.toLocaleString("en-US", { hour12: true });
                        }
                    }

                } else { //NO ES COPIA
                    if (objeto.ID_activity == idVisita) {
                        item = objeto;
                        //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                        item.onserver = false;
                        item.action = "update"
                        item.isfinished = true;
                        item.check_out = now.toLocaleString("en-US", { hour12: true });
                    }
                }

  

            });
            localStorage.setItem('activities', JSON.stringify(retrievedArrayA));
                         var url = '@Url.Action("Details", "VisitsMs", new {id= ViewBag.idvisitareal })';
            $("#loading").hide();
            window.location.href = url;
        }




    };

    function error2(err) {
        console.warn('ERROR(' + err.code + '): ' + err.message);
        $("#loading").show();

            var idVisita;
            try {
                idVisita = @ViewBag.idvisita;
            } catch{
                idVisita = "@ViewBag.idvisita";

            }          
            if (idVisita == "copy") {
                idVisita = getCookie("IDactivitycopy");
            }

        if (isOnLine()) {
            var now = new Date();
            var retrievedArrayA = JSON.parse(localStorage.getItem('activities'));
            retrievedArrayA.forEach(function (objeto) {
                if (idVisita.toString().length > 4) {
                    if (idVisita.toString().substring(0, 4) == "copy") {//ES COPIA
                        if (objeto.query1 == idVisita) {
                            item = objeto;
                            //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                            item.onserver = false;
                            item.action = "update"
                            item.isfinished = true;
                            item.check_out = now.toLocaleString("en-US", { hour12: true });
                        }
                    } else { //NO ES COPIA
                        if (objeto.ID_activity == idVisita) {
                            item = objeto;
                            //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                            item.onserver = false;
                            item.action = "update"
                            item.isfinished = true;
                            item.check_out = now.toLocaleString("en-US", { hour12: true });
                        }
                    }

                } else { //NO ES COPIA
                    if (objeto.ID_activity == idVisita) {
                        item = objeto;
                        //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                        item.onserver = false;
                        item.action = "update"
                        item.isfinished = true;
                        item.check_out = now.toLocaleString("en-US", { hour12: true });
                    }
                }



            });
            localStorage.setItem('activities', JSON.stringify(retrievedArrayA));


        $.ajax({
            url: '/FormsM/Finish_activity',
            type: 'POST',
            data: { 'id': idVisita, 'lat': "", 'lng': "", 'check_out': now.toLocaleString("en-US", { hour12: true }) },
            complete: function () {

            },
            success: function (result) {

                 var url = '@Url.Action("Details", "VisitsMs", new {id= ViewBag.idvisitareal })';
                $("#loading").hide();


                var retrievedArrayA = JSON.parse(localStorage.getItem('activities'));
                retrievedArrayA.forEach(function (objeto) {
                    if (idVisita.toString().length > 4) {
                        if (idVisita.toString().substring(0, 4) == "copy") {//ES COPIA
                            if (objeto.query1 == idVisita) {
                                item = objeto;
                                //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                                item.onserver = false;
                                item.action = "saved"
                            }
                        } else { //NO ES COPIA
                            if (objeto.ID_activity == idVisita) {
                                item = objeto;
                                //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                                item.onserver = false;
                                item.action = "saved"
                            }
                        }

                    } else { //NO ES COPIA
                        if (objeto.ID_activity == idVisita) {
                            item = objeto;
                            //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                            item.onserver = false;
                            item.action = "saved"
                        }
                    }

 

                });
                localStorage.setItem('activities', JSON.stringify(retrievedArrayA));

                    window.location.href = url;

            },
            error: function (request) {

                $("#loading").hide();
                window.location.reload(true);
            }
        });

        } else {
            var now = new Date();
            var retrievedArrayA = JSON.parse(localStorage.getItem('activities'));
            retrievedArrayA.forEach(function (objeto) {
                if (idVisita.toString().length > 4) {
                    if (idVisita.toString().substring(0, 4) == "copy") {//ES COPIA
                        if (objeto.query1 == idVisita) {
                            item = objeto;
                            //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                            item.onserver = false;
                            item.action = "update"
                            item.isfinished = true;
                            item.check_out = now.toLocaleString("en-US", { hour12: true });
                        }
                    } else { //NO ES COPIA
                        if (objeto.ID_activity == idVisita) {
                            item = objeto;
                            //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                            item.onserver = false;
                            item.action = "update"
                            item.isfinished = true;
                            item.check_out = now.toLocaleString("en-US", { hour12: true });
                        }
                    }

                } else { //NO ES COPIA
                    if (objeto.ID_activity == idVisita) {
                        item = objeto;
                        //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                        item.onserver = false;
                        item.action = "update"
                        item.isfinished = true;
                        item.check_out = now.toLocaleString("en-US", { hour12: true });
                    }
                }



            });
            localStorage.setItem('activities', JSON.stringify(retrievedArrayA));
             var url = '@Url.Action("Details", "VisitsMs", new {id= ViewBag.idvisitareal })';
            $("#loading").hide();
            window.location.href = url;
        }

    };



    function initGeolocation2() {
        if (navigator && navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(success2, error2, options2);
        } else {
            $("#loading").hide();
            console.log('Geolocation is not supported');
        }
    }

</script>



<script>
    function OrderedList(parentList,main_container, parent = 0, selectid="") {
        //#main_container es el contenedor principal donde se estructuran los div principales
        parentList.forEach(function (objeto) {
            //< !--PARA TITULOS-- >
            if (objeto.id_resource == 1) {
                $("" + main_container + "").append('<div class="row" id="main_container_child' + objeto.idkey + '">');
                $("#main_container_child" + objeto.idkey + "").append('<hr />');
                $("#main_container_child" + objeto.idkey + "").append('<div class="form-horizontal" id="main_container_subchild' + objeto.idkey + '">');
                $("#main_container_subchild" + objeto.idkey + "").append('<hr />');
                $("#main_container_subchild" + objeto.idkey + "").append('<h5 class="display-4 text-warning" style="text-align:center;">' + objeto.fsource + '</h5>');
                $("#main_container_subchild" + objeto.idkey + "").append('<hr />');
                $("#main_container_child" + objeto.idkey + "").append('</div>');
                $("#main_container_child" + objeto.idkey + "").append('<hr />');
                $("" + main_container + "").append('</div>');

            }
            //<!--PARA SUBTITULOS -->
            if (objeto.id_resource == 8) {

                if (objeto.children.length > 0) {
                    if (objeto.children[0].id_resource == 19) {
                        $("" + main_container + "").append('<div class="card" id="main_container_child' + objeto.idkey + '">');
                        $("#main_container_child" + objeto.idkey + "").append('<div class="card-body" id="main_container_subchild' + objeto.idkey + '">');
                        $("#main_container_subchild" + objeto.idkey + "").append('<div class="form-group" id="main_container_subsubchild' + objeto.idkey + '">');
                        $("#main_container_subsubchild" + objeto.idkey + "").append('<p class="control-label">' + objeto.fsource + '</p>');
                        $("#main_container_subsubchild" + objeto.idkey + "").append('<div class="parentdiv flexRadio" id="main_container_subsubsubchild' + objeto.idkey + '">');

                        OrderedList(objeto.children, "#main_container_subsubsubchild" + objeto.idkey + "", objeto.idkey)

                        $("#main_container_subsubchild" + objeto.idkey + "").append('</div>');
                        $("#main_container_subchild" + objeto.idkey + "").append('</div>');
                        $("#main_container_child" + objeto.idkey + "").append('</div>');
                        $("" + main_container + "").append('</div>');
                    } else {
                        $("" + main_container + "").append('<div class="card" id="main_container_child' + objeto.idkey + '">');
                        $("#main_container_child" + objeto.idkey + "").append('<div class="card-body" id="main_container_subchild' + objeto.idkey + '">');
                        $("#main_container_subchild" + objeto.idkey + "").append('<div class="form-group" id="main_container_subsubchild' + objeto.idkey + '">');
                        $("#main_container_subsubchild" + objeto.idkey + "").append('<p class="control-label">' + objeto.fsource + '</p>');
                        $("#main_container_subsubchild" + objeto.idkey + "").append('<div class="parentdiv" id="main_container_subsubsubchild' + objeto.idkey + '">');

                        OrderedList(objeto.children, "#main_container_subsubsubchild" + objeto.idkey + "", objeto.idkey)

                        $("#main_container_subsubchild" + objeto.idkey + "").append('</div>');
                        $("#main_container_subchild" + objeto.idkey + "").append('</div>');
                        $("#main_container_child" + objeto.idkey + "").append('</div>');
                        $("" + main_container + "").append('</div>');
                    }
                } else {
                    $("" + main_container + "").append('<div class="row" id="main_container_child' + objeto.idkey + '">');
                    $("#main_container_child" + objeto.idkey + "").append('<div class="col-md-12 grid-margin" id="main_container_subchild' + objeto.idkey + '">');
                    $("#main_container_subchild" + objeto.idkey + "").append('<hr />');
                    $("#main_container_subchild" + objeto.idkey + "").append('<h6 style="text-align:center;">' + objeto.fsource + '</h6>');
                    $("#main_container_subchild" + objeto.idkey + "").append('<hr />');
                    $("#main_container_child" + objeto.idkey + "").append('</div>');
                    $("" + main_container + "").append('</div>');
                }

            }
            //< !--PARA INPUT TEXT-- >
            if (objeto.id_resource == 6) {
                $("" + main_container + "").append('<div class="card" id="main_container_child' + objeto.idkey + '">');
                $("#main_container_child" + objeto.idkey + "").append('<div class="card-body" id="main_container_subchild' + objeto.idkey + '">');
                $("#main_container_subchild" + objeto.idkey + "").append('<div class="form-group" id="main_container_subsubchild' + objeto.idkey + '">');
                if (objeto.fvalue == 0) {
                    $("#main_container_subsubchild" + objeto.idkey + "").append('<p class="control-label col-md-10">' + objeto.fdescription + ' (*)</p>');
                }
                else if (objeto.fvalue == 1) {
                    $("#main_container_subsubchild" + objeto.idkey + "").append('<p class="control-label col-md-10"> Flavor - ' + objeto.fdescription + ' (*)</p>');
                }
                else if (objeto.fvalue == 2) {
                    $("#main_container_subsubchild" + objeto.idkey + "").append('<p class="control-label col-md-10"> Quality - ' + objeto.fdescription + ' (*)</p>');
                }
                else if (objeto.fvalue == 3) {
                    $("#main_container_subsubchild" + objeto.idkey + "").append('<p class="control-label col-md-10"> Price - ' + objeto.fdescription + ' (*)</p>');
                }
                else if (objeto.fvalue == 4) {
                    $("#main_container_subsubchild" + objeto.idkey + "").append('<p class="control-label col-md-10"> Packing - ' + objeto.fdescription + ' (*)</p>');
                }
                else if (objeto.fvalue == 5) {
                    $("#main_container_subsubchild" + objeto.idkey + "").append('<p class="control-label col-md-10"> Free - ' + objeto.fdescription + ' (*)</p>');
                }
                $("#main_container_subsubchild" + objeto.idkey + "").append('<div class="col-md-12" id="main_container_subsubsubchild' + objeto.idkey + '">');
                $("#main_container_subsubsubchild" + objeto.idkey + "").append('<textarea id="' + objeto.idkey + '" class="form-control" onkeypress="return ((event.charCode >= 65 && event.charCode <= 90) || (event.charCode >= 97 && event.charCode <= 122) || (event.charCode == 32))">' + objeto.fsource + '</textarea>');
                $("#main_container_subsubchild" + objeto.idkey + "").append('</div>');
                $("#main_container_subchild" + objeto.idkey + "").append('</div>');
                $("#main_container_child" + objeto.idkey + "").append('</div>');
                $("" + main_container + "").append('</div>');
            }

            // <!--PARA PRODUCTOS -->
            if (objeto.id_resource == 3) {
                $("" + main_container + "").append('<div class="card" id="main_container_child' + objeto.idkey + '">');
                $("#main_container_child" + objeto.idkey + "").append('<div class="card-body" id="main_container_subchild' + objeto.idkey + '">');
                $("#main_container_subchild" + objeto.idkey + "").append('<div class="form-group" id="main_container_subsubchild' + objeto.idkey + '">');
                $("#main_container_subsubchild" + objeto.idkey + "").append('<p class="control-label col-md-10">' + objeto.fdescription + ' (*)</p>');
                $("#main_container_subsubchild" + objeto.idkey + "").append('<div class="col-md-12" id="main_container_subsubsubchild' + objeto.idkey + '">');
                $("#main_container_subsubsubchild" + objeto.idkey + "").append('<input type="number" min="0" inputmode="numeric" pattern="[0-9]*" value="' + objeto.fvalue + '" class="form-control" id="' + objeto.idkey + ' required"/>');
                $("#main_container_subsubchild" + objeto.idkey + "").append('</div>');
                $("#main_container_subchild" + objeto.idkey + "").append('</div>');
                $("#main_container_child" + objeto.idkey + "").append('</div>');
                $("" + main_container + "").append('</div>');
            }
            // <!--PARA MUESTRAS -->
            if (objeto.id_resource == 4) {
                $("" + main_container + "").append('<div class="card" id="main_container_child' + objeto.idkey + '">');
                $("#main_container_child" + objeto.idkey + "").append('<div class="card-body" id="main_container_subchild' + objeto.idkey + '">');
                $("#main_container_subchild" + objeto.idkey + "").append('<div class="form-group" id="main_container_subsubchild' + objeto.idkey + '">');
                $("#main_container_subsubchild" + objeto.idkey + "").append('<p class="control-label col-md-10">' + objeto.fdescription + ' (*)</p>');
                $("#main_container_subsubchild" + objeto.idkey + "").append('<div class="col-md-12" id="main_container_subsubsubchild' + objeto.idkey + '">');
                $("#main_container_subsubsubchild" + objeto.idkey + "").append('<input type="number" min="0" inputmode="numeric" pattern="[0-9]*" value="' + objeto.fvalue + '" class="form-control" id="' + objeto.idkey + ' required"/>');
                $("#main_container_subsubchild" + objeto.idkey + "").append('</div>');
                $("#main_container_subchild" + objeto.idkey + "").append('</div>');
                $("#main_container_child" + objeto.idkey + "").append('</div>');
                $("" + main_container + "").append('</div>');
            }

            // <!--PARA GIFTS -->
            if (objeto.id_resource == 10) {
                $("" + main_container + "").append('<div class="card" id="main_container_child' + objeto.idkey + '">');
                $("#main_container_child" + objeto.idkey + "").append('<div class="card-body" id="main_container_subchild' + objeto.idkey + '">');
                $("#main_container_subchild" + objeto.idkey + "").append('<div class="form-group" id="main_container_subsubchild' + objeto.idkey + '">');
                $("#main_container_subsubchild" + objeto.idkey + "").append('<p class="control-label col-md-10">' + objeto.fdescription + ' (*)</p>');
                $("#main_container_subsubchild" + objeto.idkey + "").append('<div class="col-md-12" id="main_container_subsubsubchild' + objeto.idkey + '">');
                $("#main_container_subsubsubchild" + objeto.idkey + "").append('<input type="number" min="0" inputmode="numeric" pattern="[0-9]*" value="' + objeto.fvalue + '" class="form-control" id="' + objeto.idkey + ' required"/>');
                $("#main_container_subsubchild" + objeto.idkey + "").append('</div>');
                $("#main_container_subchild" + objeto.idkey + "").append('</div>');
                $("#main_container_child" + objeto.idkey + "").append('</div>');
                $("" + main_container + "").append('</div>');
            }

            //<!--RADIO SELECCION UNICA -->
            if (objeto.id_resource == 19) {
                if (objeto.parent != 0) {
                    $("" + main_container + "").append('<div class="form-radio hRadio col-6" id="main_container_child' + objeto.idkey + '">');
                    $("#main_container_child" + objeto.idkey + "").append('<label class="form-check-label" id="label_container' + objeto.idkey + '" >');
                    if (objeto.fvalue == 0) {
                        $("#label_container" + objeto.idkey + "").append('<input type="radio" class="form-check-input rad" name="radio_' + objeto.parent + '" id="' + objeto.idkey + '" value="' + objeto.fsource + '" />');
                        $("#label_container" + objeto.idkey + "").append('<i class="input-helper"></i>');
                    }
                    else {
                        $("#label_container" + objeto.idkey + "").append('<input type="radio" class="form-check-input rad" name="radio_' + objeto.parent + '" id="' + objeto.idkey + '" value="' + objeto.fsource + '" checked />');
                        $("#label_container" + objeto.idkey + "").append('<i class="input-helper"></i>');
                    }
                    $("#label_container" + objeto.idkey + "").append('' + objeto.fsource + '');
                    $("#main_container_child" + objeto.idkey + "").append('</label>');
                    $("" + main_container + "").append('</div>');
                    if (objeto.children.length > 0) {
                        $("" + main_container + "").append('<div class="parentdiv fRadio col-12" id="main_container_child2' + objeto.idkey + '">');
                        if (objeto.fvalue == 0) {
                            $("#main_container_child2" + objeto.idkey + "").append('<div class="childdivradio_' + objeto.parent + '" id="radiodiv_' + objeto.idkey + '" style="display:none;">');
                            $("#radiodiv_" + objeto.idkey + "").append('<hr />');

                            OrderedList(objeto.children, "#radiodiv_" + objeto.idkey + "", objeto.idkey)

                            $("#main_container_child2" + objeto.idkey + "").append('</div>');
                        }
                        else {
                            $("#main_container_child2" + objeto.idkey + "").append('<div class="childdivradio_' + objeto.parent + '" id="radiodiv_' + objeto.idkey + '" >');
                            $("#radiodiv_" + objeto.idkey + "").append('<hr />');

                            OrderedList(objeto.children, "#radiodiv_" + objeto.idkey + "", objeto.idkey)

                            $("#main_container_child2" + objeto.idkey + "").append('</div>');

                        }
                        $("" + main_container + "").append('</div>');
                    } else {

                    }
                }
                else {
                    $("" + main_container + "").append('<div class="card" id="main_container_child' + objeto.idkey + '">');
                    $("#main_container_child" + objeto.idkey + "").append('<div class="" id="main_container_subchild' + objeto.idkey + '">');
                    $("#main_container_subchild" + objeto.idkey + "").append('<div class="form-group" id="main_container_subsubchild' + objeto.idkey + '">');
                    $("#main_container_subsubchild" + objeto.idkey + "").append('<div class="form-radio" id="main_container_subsubsubchild' + objeto.idkey + '">');
                    $("#main_container_subsubsubchild" + objeto.idkey + "").append('<label class="form-check-label" id="label_container' + objeto.idkey + '" >');
                    if (objeto.fvalue == 0) {
                        $("#label_container" + objeto.idkey + "").append('<input type="radio" class="form-check-input rad" name="radio_' + parent + '" id="' + objeto.idkey + '" value="' + objeto.fsource + '">');
                        $("#label_container" + objeto.idkey + "").append('<i class="input-helper"></i>');
                    }
                    else {
                        $("#label_container" + objeto.idkey + "").append('<input type="radio" class="form-check-input rad" name="radio_' + parent + '" id="' + objeto.idkey + '" value="' + objeto.fsource + '" checked>');
                        $("#label_container" + objeto.idkey + "").append('<i class="input-helper"></i>');
                    }
                    $("#label_container" + objeto.idkey + "").append('' + objeto.fsource + '');
                    $("#main_container_subsubsubchild" + objeto.idkey + "").append('</label>');
                    $("#main_container_subsubchild" + objeto.idkey + "").append('</div>');
                    $("#main_container_subchild" + objeto.idkey + "").append('</div>');
                    $("#main_container_child" + objeto.idkey + "").append('</div>');
                    $("" + main_container + "").append('</div>');
                }

            }

            ////<!--CHECK SELECCION MULTIPLE -->
            if (objeto.id_resource == 16) {
                if (objeto.parent != 0) {
                    $("" + main_container + "").append('<div class="form-check" id="main_container_child' + objeto.idkey + '">');
                    $("#main_container_child" + objeto.idkey + "").append('<label class="form-check-label" id="label_container' + objeto.idkey + '" >');
                    if (objeto.fvalue == 0) {
                        $("#label_container" + objeto.idkey + "").append('<input type="checkbox" class="form-check-input chk" name="radio_' + objeto.parent + '" id="' + objeto.idkey + '" value="' + objeto.fsource + '" />');
                        //$("#label_container" + objeto.idkey + "").append('<i class="input-helper"></i>');
                    }
                    else {
                        $("#label_container" + objeto.idkey + "").append('<input type="radio" class="form-check-input chk" name="radio_' + objeto.parent + '" id="' + objeto.idkey + '" value="' + objeto.fsource + '" checked />');
                        //$("#label_container" + objeto.idkey + "").append('<i class="input-helper"></i>');
                    }
                    $("#label_container" + objeto.idkey + "").append('' + objeto.fsource + '');
                    $("#main_container_child" + objeto.idkey + "").append('</label>');
                    $("" + main_container + "").append('</div>');
                    if (objeto.children.length > 0) {
                        $("" + main_container + "").append('<div class="col-md-12 parentdiv" id="main_container_child2' + objeto.idkey + '">');
                        if (objeto.fvalue == 0) {
                            $("#main_container_child2" + objeto.idkey + "").append('<div class="childdivradio_' + objeto.parent + '" id="radiodiv_' + objeto.idkey + '" style="display:none;">');
                            $("#radiodiv_" + objeto.idkey + "").append('<hr />');

                            OrderedList(objeto.children, "#radiodiv_" + objeto.idkey + "", objeto.idkey)

                            $("#main_container_child2" + objeto.idkey + "").append('</div>');
                        }
                        else {
                            $("#main_container_child2" + objeto.idkey + "").append('<div class="childdivradio_' + objeto.parent + '" id="radiodiv_' + objeto.idkey + '" >');
                            $("#radiodiv_" + objeto.idkey + "").append('<hr />');

                            OrderedList(objeto.children, "#radiodiv_" + objeto.idkey + "", objeto.idkey)

                            $("#main_container_child2" + objeto.idkey + "").append('</div>');

                        }
                        $("" + main_container + "").append('</div>');
                    }
                }
                else {
                    $("" + main_container + "").append('<div class="card" id="main_container_child' + objeto.idkey + '">');
                    $("#main_container_child" + objeto.idkey + "").append('<div class="" id="main_container_subchild' + objeto.idkey + '">');
                    $("#main_container_subchild" + objeto.idkey + "").append('<div class="form-group" id="main_container_subsubchild' + objeto.idkey + '">');
                    $("#main_container_subsubchild" + objeto.idkey + "").append('<div class="form-check" id="main_container_subsubsubchild' + objeto.idkey + '">');
                    $("#main_container_subsubsubchild" + objeto.idkey + "").append('<label class="form-check-label" id="label_container' + objeto.idkey + '" >');
                    if (objeto.fvalue == 0) {
                        $("#label_container" + objeto.idkey + "").append('<input type="checkbox" class="form-check-input chk" name="radio_' + parent + '" id="' + objeto.idkey + '" value="' + objeto.fsource + '">');
                        //$("#label_container" + objeto.idkey + "").append('<i class="input-helper"></i>');
                    }
                    else {
                        $("#label_container" + objeto.idkey + "").append('<input type="checkbox" class="form-check-input chk" name="radio_' + parent + '" id="' + objeto.idkey + '" value="' + objeto.fsource + '" checked>');
                        //$("#label_container" + objeto.idkey + "").append('<i class="input-helper"></i>');
                    }
                    $("#label_container" + objeto.idkey + "").append('' + objeto.fsource + '');
                    $("#main_container_subsubsubchild" + objeto.idkey + "").append('</label>');
                    $("#main_container_subsubchild" + objeto.idkey + "").append('</div>');
                    $("#main_container_subchild" + objeto.idkey + "").append('</div>');
                    $("#main_container_child" + objeto.idkey + "").append('</div>');
                    $("" + main_container + "").append('</div>');
                }
            }

                //<!--PARA IMAGENES -->
                if (objeto.id_resource == 5) {
                    if (objeto.parent != 0) {
                        $("" + main_container + "").append('<p class="control-label col-md-10">' + objeto.fdescription + '</p>');
                        $("" + main_container + "").append('<div class="col-md-12" id="main_container_child' + objeto.idkey + '">');
                        if (objeto.fsource != "") {
                            $("#main_container_child" + objeto.idkey + "").append('<input type="file" data-changeflag="0" class="dropifyIMG" id="' + objeto.idkey + '" data-default-file="' + objeto.fsource.substring(1) + '" data-max-file-size-preview="15M">');
                            $("#main_container_child" + objeto.idkey + "").append('<img id="img_' + objeto.idkey + '" alt="your image" hidden />');
                            $("#main_container_child" + objeto.idkey + "").append('<img id="resultimg_' + objeto.idkey + '" alt="your image" hidden />');
                        }
                        else {
                            $("#main_container_child" + objeto.idkey + "").append('<input type="file" data-changeflag="0" class="dropifyIMG" id="' + objeto.idkey + '" data-max-file-size-preview="15M">');
                            $("#main_container_child" + objeto.idkey + "").append('<img id="img_' + objeto.idkey + '" alt="your image" hidden />');
                            $("#main_container_child" + objeto.idkey + "").append('<img id="resultimg_' + objeto.idkey + '" alt="your image" hidden />');


                        }
                        $("" + main_container + "").append('</div>');
                    }
                    else {
                        $("" + main_container + "").append('<div class="card" id="main_container_child' + objeto.idkey + '">');
                        $("#main_container_child" + objeto.idkey + "").append('<div class="card-body" id="main_container_subchild' + objeto.idkey + '">');
                        $("#main_container_subchild" + objeto.idkey + "").append('<p class="control-label col-md-10">' + objeto.fdescription + '</p>');
                        $("#main_container_subchild" + objeto.idkey + "").append('<div class="col-md-12" id="main_container_subsubchild' + objeto.idkey + '">');
                        if (objeto.fsource != "") {
                            $("#main_container_subsubchild" + objeto.idkey + "").append('<input type="file" data-changeflag="0" class="dropifyIMG" id="' + objeto.idkey + '" data-default-file="' + objeto.fsource.substring(1) + '" data-max-file-size-preview="15M">');
                            $("#main_container_subsubchild" + objeto.idkey + "").append('<img id="img_' + objeto.idkey + '" alt="your image" hidden />');
                            $("#main_container_subsubchild" + objeto.idkey + "").append('<img id="resultimg_' + objeto.idkey + '" alt="your image" hidden />');
                        }
                        else {
                            $("#main_container_subsubchild" + objeto.idkey + "").append('<input type="file" data-changeflag="0" class="dropifyIMG" id="' + objeto.idkey + '" data-max-file-size-preview="15M">');
                            $("#main_container_subsubchild" + objeto.idkey + "").append('<img id="img_' + objeto.idkey + '" alt="your image" hidden />');
                            $("#main_container_subsubchild" + objeto.idkey + "").append('<img id="resultimg_' + objeto.idkey + '" alt="your image" hidden />');

                        }
                        $("#main_container_subchild" + objeto.idkey + "").append('</div>');
                        $("#main_container_child" + objeto.idkey + "").append('</div>');
                        $("" + main_container + "").append('</div>');
                    }


                }

                //<!--PARA INPUT NUMBER -->
                if (objeto.id_resource == 18) {
                    if (objeto.parent != 0) {

                        $("" + main_container + "").append('<div class="form-group" id="main_container_child' + objeto.idkey + '">');
                        $("#main_container_child" + objeto.idkey + "").append('<p class="control-label col-md-10">' + objeto.fsource + '</p>');
                        $("#main_container_child" + objeto.idkey + "").append('<div class="col-md-12" id="main_container_subchild' + objeto.idkey + '">');
                        $("#main_container_subchild" + objeto.idkey + "").append('<input type="number"  id="' + objeto.idkey + '" name="' + objeto.idkey + '" class="form-control" value="' + objeto.fvalueDecimal + '" />');
                        $("#main_container_child" + objeto.idkey + "").append('</div>');
                        $("" + main_container + "").append('</div>');
                    }
                    else {
                        $("" + main_container + "").append('<div class="card" id="main_container_child' + objeto.idkey + '">');
                        $("#main_container_child" + objeto.idkey + "").append('<div class="card-body" id="main_container_subchild' + objeto.idkey + '">');
                        $("#main_container_subchild" + objeto.idkey + "").append('<div class="form-group" id="main_container_subsubchild' + objeto.idkey + '">');
                        $("#main_container_subsubchild" + objeto.idkey + "").append('<p class="control-label col-md-10">' + objeto.fsource + ' (*)</p>');
                        $("#main_container_subsubchild" + objeto.idkey + "").append('<div class="col-md-12" id="main_container_subsubsubchild' + objeto.idkey + '">');
                        $("#main_container_subsubsubchild" + objeto.idkey + "").append('<input type="number"  id="' + objeto.idkey + '" name="' + objeto.idkey + '" class="form-control" value="' + objeto.fvalueDecimal + '" />');
                        $("#main_container_subsubchild" + objeto.idkey + "").append('</div>');
                        $("#main_container_subchild" + objeto.idkey + "").append('</div>');
                        $("#main_container_child" + objeto.idkey + "").append('</div>');
                        $("" + main_container + "").append('</div>');
                    }
                }
                //<!--PARA INPUT NUMBER (CURRENCY)-->
                if (objeto.id_resource == 21) {
                    if (objeto.parent != 0) {
                        $("" + main_container + "").append('<div class="form-group" id="main_container_child' + objeto.idkey + '">');
                        $("#main_container_child" + objeto.idkey + "").append('<p class="control-label col-md-10">' + objeto.fdescription + '</p>');
                        $("#main_container_child" + objeto.idkey + "").append('<div class="col-md-12" id="main_container_subchild' + objeto.idkey + '">');
                        $("#main_container_subchild" + objeto.idkey + "").append('<input type="number"  id="' + objeto.idkey + '" name="' + objeto.idkey + '" class="form-control currency" value="' + objeto.fvalueDecimal + '" />');
                        $("#main_container_child" + objeto.idkey + "").append('</div>');
                        $("" + main_container + "").append('</div>');
                    }
                    else {
                        $("" + main_container + "").append('<div class="card" id="main_container_child' + objeto.idkey + '">');
                        $("#main_container_child" + objeto.idkey + "").append('<div class="card-body" id="main_container_subchild' + objeto.idkey + '">');
                        $("#main_container_subchild" + objeto.idkey + "").append('<div class="form-group" id="main_container_subsubchild' + objeto.idkey + '">');
                        $("#main_container_subsubchild" + objeto.idkey + "").append('<p class="control-label col-md-10">' + objeto.fsource + ' (*)</p>');
                        $("#main_container_subsubchild" + objeto.idkey + "").append('<div class="col-md-12" id="main_container_subsubsubchild' + objeto.idkey + '">');
                        $("#main_container_subsubsubchild" + objeto.idkey + "").append('<input type="number"  id="' + objeto.idkey + '" name="' + objeto.idkey + '" class="form-control currency" value="' + objeto.fvalueDecimal + '" />');
                        $("#main_container_subsubchild" + objeto.idkey + "").append('</div>');
                        $("#main_container_subchild" + objeto.idkey + "").append('</div>');
                        $("#main_container_child" + objeto.idkey + "").append('</div>');
                        $("" + main_container + "").append('</div>');
                    }
                }


                //<!--PARA CUSTOMERS -->
                if (objeto.id_resource == 12) {

                    $("" + main_container + "").append('<div class="card" id="main_container_child' + objeto.idkey + '">');
                    $("#main_container_child" + objeto.idkey + "").append('<div class="card-body" id="main_container_subchild' + objeto.idkey + '">');
                    $("#main_container_subchild" + objeto.idkey + "").append('<div class="form-group" id="main_container_subsubchild' + objeto.idkey + '">');
                    $("#main_container_subsubchild" + objeto.idkey + "").append('<p class="control-label col-md-10">' + objeto.fsource + ' (*)</p>');
                    $("#main_container_subsubchild" + objeto.idkey + "").append('<div class="col-md-12" id="main_container_subsubsubchild' + objeto.idkey + '">');
                    $("#main_container_subsubsubchild" + objeto.idkey + "").append('<select id="customer_list" class="form-control" name="' + objeto.idkey + '" style="width:100%" onChange="getBrands()">');
                    var customers = @Html.Raw(ViewBag.customers);
                    if (customers.length == 1) {
                        $("#customer_list").append($('<option selected></option>').val(customers[0].CardCode).html(customers[0].CardCode + " - " + customers[0].CardName));
                    }
                    else {
                        $("#customer_list").append($('<option selected></option>').val(0).html("Seleccione un cliente"));
                        customers.forEach(function (itemCustomer) {

                            if (objeto.fvalueText == itemCustomer.CardCode) {
                                $("#customer_list").append($('<option selected></option>').val(itemCustomer.CardCode).html(itemCustomer.CardCode + " - " + itemCustomer.CardName));
                            }

                            else {
                                $("#customer_list").append($('<option></option>').val(itemCustomer.CardCode).html(itemCustomer.CardCode + " - " + itemCustomer.CardName));
                            }
                        });

                    }
                    $("#main_container_subsubsubchild" + objeto.idkey + "").append('</select>');
                    $("#main_container_subsubchild" + objeto.idkey + "").append('</div>');
                    $("#main_container_subchild" + objeto.idkey + "").append('</div>');
                    $("#main_container_child" + objeto.idkey + "").append('</div>');
                    $("" + main_container + "").append('</div>');

            }


            // <!--PARA BRANDS-->
            if (objeto.id_resource == 13)
            {
                $("" + main_container + "").append('<div class="card" id="main_container_child' + objeto.idkey + '">');
                $("#main_container_child" + objeto.idkey + "").append('<div class="card-body" id="main_container_subchild' + objeto.idkey + '">');
                $("#main_container_subchild" + objeto.idkey + "").append('<div class="form-group" id="main_container_subsubchild' + objeto.idkey + '">');
                $("#main_container_subsubchild" + objeto.idkey + "").append('<p class="control-label col-md-10">' + objeto.fsource + ' (*)</p>');
                $("#main_container_subsubchild" + objeto.idkey + "").append('<div class="col-md-12" id="main_container_subsubsubchild' + objeto.idkey + '">');
                $("#main_container_subsubsubchild" + objeto.idkey + "").append('<select id="brands_list" class="form-control" name="' + objeto.idkey + '" style="width:100%" onChange="getProductsline()">');
                $("#brands_list").append($('<option selected></option>').val(0).html("Seleccione una marca"));
                $("#main_container_subsubsubchild" + objeto.idkey + "").append('</select>');
                $("#main_container_subsubchild" + objeto.idkey + "").append('</div>');
                $("#main_container_subchild" + objeto.idkey + "").append('</div>');
                $("#main_container_child" + objeto.idkey + "").append('</div>');
                $("" + main_container + "").append('</div>');
            }

            // <!--PARA PRODUCT LINE-->
            if (objeto.id_resource == 14) {
                $("" + main_container + "").append('<div class="card" id="main_container_child' + objeto.idkey + '">');
                $("#main_container_child" + objeto.idkey + "").append('<div class="card-body" id="main_container_subchild' + objeto.idkey + '">');
                $("#main_container_subchild" + objeto.idkey + "").append('<div class="form-group" id="main_container_subsubchild' + objeto.idkey + '">');
                $("#main_container_subsubchild" + objeto.idkey + "").append('<p class="control-label col-md-10">' + objeto.fsource + ' (*)</p>');
                $("#main_container_subsubchild" + objeto.idkey + "").append('<div class="col-md-12" id="main_container_subsubsubchild' + objeto.idkey + '">');
                $("#main_container_subsubsubchild" + objeto.idkey + "").append('<select id="productline_list" class="form-control" name="' + objeto.idkey + '" style="width:100%">');
                $("#productline_list").append($('<option selected></option>').val(0).html("Seleccione un linea de producto"));
                $("#main_container_subsubsubchild" + objeto.idkey + "").append('</select>');
                $("#main_container_subsubchild" + objeto.idkey + "").append('</div>');
                $("#main_container_subchild" + objeto.idkey + "").append('</div>');
                $("#main_container_child" + objeto.idkey + "").append('</div>');
                $("" + main_container + "").append('</div>');
            }

            //  <!--PARA BRAND COMPETITORS -->
            if (objeto.id_resource == 15) {
                $("" + main_container + "").append('<div class="card" id="main_container_child' + objeto.idkey + '">');
                $("#main_container_child" + objeto.idkey + "").append('<div class="card-body" id="main_container_subchild' + objeto.idkey + '">');
                $("#main_container_subchild" + objeto.idkey + "").append('<div class="form-group" id="main_container_subsubchild' + objeto.idkey + '">');
                $("#main_container_subsubchild" + objeto.idkey + "").append('<p class="control-label col-md-10">' + objeto.fsource + ' (*)</p>');
                $("#main_container_subsubchild" + objeto.idkey + "").append('<div class="col-md-12" id="main_container_subsubsubchild' + objeto.idkey + '">');
                $("#main_container_subsubsubchild" + objeto.idkey + "").append('<select id="brandcompetitors_list" class="form-control" name="' + objeto.idkey + '" style="width:100%">');
                $("#brandcompetitors_list").append($('<option selected></option>').val(0).html("Seleccione competidor de la marca"));
                $("#main_container_subsubsubchild" + objeto.idkey + "").append('</select>');
                $("#main_container_subsubchild" + objeto.idkey + "").append('</div>');
                $("#main_container_subchild" + objeto.idkey + "").append('</div>');
                $("#main_container_child" + objeto.idkey + "").append('</div>');
                $("" + main_container + "").append('</div>');
            }

            // <!--PARA SELECT GENERAL -->
            if (objeto.id_resource == 17) {
                $("" + main_container + "").append('<div class="card" id="main_container_child' + objeto.idkey + '">');
                $("#main_container_child" + objeto.idkey + "").append('<div class="card-body" id="main_container_subchild' + objeto.idkey + '">');
                $("#main_container_subchild" + objeto.idkey + "").append('<div class="form-group" id="main_container_subsubchild' + objeto.idkey + '">');
                $("#main_container_subsubchild" + objeto.idkey + "").append('<p class="control-label col-md-10">' + objeto.fsource + ' (*)</p>');
                $("#main_container_subsubchild" + objeto.idkey + "").append('<div class="col-md-12" id="main_container_subsubsubchild' + objeto.idkey + '">');
                $("#main_container_subsubsubchild" + objeto.idkey + "").append('<select id="' + objeto.idkey + '" class="form-control" name="' + objeto.idkey + '" style="width:100%">');
                $("#" + objeto.idkey + "").append($('<option selected></option>').val(0).html("Select an item"));

                OrderedList(objeto.children, "#" + objeto.idkey + "", objeto.idkey, objeto.fvalueText);

                $("#main_container_subsubsubchild" + objeto.idkey + "").append('</select>');
                $("#main_container_subsubchild" + objeto.idkey + "").append('</div>');
                $("#main_container_subchild" + objeto.idkey + "").append('</div>');
                $("#main_container_child" + objeto.idkey + "").append('</div>');
                $("" + main_container + "").append('</div>');
            }
            //<!--PARA ITEMS DE SELECT GENERAL -->
            if (objeto.id_resource == 20)
            {
                    if (selectid == objeto.idkey)
                    {
                        $("" + main_container + "").append('<option value="' + objeto.idkey + '" selected>' + objeto.fsource + '</option>');

                    }
                    else
                    {
                        $("" + main_container + "").append('<option value="' + objeto.idkey + '">' + objeto.fsource + '</option>');
                    }
            }

            //<!--PARA FIRMA ELECTRONICA -->
            if (objeto.id_resource == 9) {
                $("" + main_container + "").append('<div class="card" id="main_container_child' + objeto.idkey + '">');
                $("#main_container_child" + objeto.idkey + "").append('<div class="card-body" id="main_container_subchild' + objeto.idkey + '">');
                $("#main_container_subchild" + objeto.idkey + "").append('<p class="control-label col-md-10">' + objeto.fdescription + '</p>');
                $("#main_container_subchild" + objeto.idkey + "").append('<canvas id="sig-canvas" class="canvas_' + objeto.idkey + '" data-id="' + objeto.idkey + '" ontouchmove="event.preventDefault();">');
                $("#main_container_subchild" + objeto.idkey + "").append('</canvas>');

                $("#main_container_subchild" + objeto.idkey + "").append('<div class="row" id="main_container_subsubchild' + objeto.idkey + '">');
                $("#main_container_subsubchild" + objeto.idkey + "").append('<div class="col-md-12 text-center" id="main_container_subsubsubchild' + objeto.idkey + '">');
                $("#main_container_subsubsubchild" + objeto.idkey + "").append('<button class="btn btn-primary" id="sig-submitBtn" hidden>Submit Signature</button>');
                $("#main_container_subsubsubchild" + objeto.idkey + "").append('<a href="#" class="btn btn-default" id="sig-clearBtn" onclick="return false">Clear</a>');
                $("#main_container_subsubchild" + objeto.idkey + "").append('</div>');
                $("#main_container_subchild" + objeto.idkey + "").append('</div>');
                $("#main_container_child" + objeto.idkey + "").append('</div>');
                $("" + main_container + "").append('</div>');

                var canvas = document.getElementsByClassName("canvas_" + objeto.idkey);
                //var canvas = document.getElementById("sig-canvas");
                var context = canvas[0].getContext("2d");
                // load image from data url
                var imageObj = new Image();
                imageObj.onload = function () {
                    context.drawImage(this, 0, 0);
                };
                imageObj.src = objeto.fsource;

                if (document.getElementById("sig-canvas")) {



                    (function () {

                        // Get a regular interval for drawing to the screen
                        window.requestAnimFrame = (function (callback) {
                            return window.requestAnimationFrame ||
                                window.webkitRequestAnimationFrame ||
                                window.mozRequestAnimationFrame ||
                                window.oRequestAnimationFrame ||
                                window.msRequestAnimaitonFrame ||
                                function (callback) {
                                    window.setTimeout(callback, 1000 / 60);
                                };
                        })();

                        // Set up the canvas
                        var canvas = document.getElementById("sig-canvas");
                        var ctx = canvas.getContext("2d");
                        ctx.strokeStyle = "#222222";
                        ctx.lineWith = 2;





                        // Set up the UI
                        var sigText = document.getElementById("sig-dataUrl");
                        var sigImage = document.getElementById("sig-image");
                        var clearBtn = document.getElementById("sig-clearBtn");
                        var submitBtn = document.getElementById("sig-submitBtn");
                        clearBtn.addEventListener("click", function (e) {
                            clearCanvas();
                            //sigText.innerHTML = "Data URL for your signature will go here!";
                            //sigImage.setAttribute("src", "");
                        }, false);
                        submitBtn.addEventListener("click", function (e) {
                            var dataUrl = canvas.toDataURL();
                            sigText.innerHTML = dataUrl;
                            sigImage.setAttribute("src", dataUrl);

                        }, false);

                        // Set up mouse events for drawing
                        var drawing = false;
                        var mousePos = { x: 0, y: 0 };
                        var lastPos = mousePos;
                        canvas.addEventListener("mousedown", function (e) {
                            drawing = true;
                            lastPos = getMousePos(canvas, e);
                        }, false);
                        canvas.addEventListener("mouseup", function (e) {
                            drawing = false;
                        }, false);
                        canvas.addEventListener("mousemove", function (e) {
                            mousePos = getMousePos(canvas, e);
                        }, false);

                        // Set up touch events for mobile, etc
                        canvas.addEventListener("touchstart", function (e) {
                            mousePos = getTouchPos(canvas, e);
                            var touch = e.touches[0];
                            var mouseEvent = new MouseEvent("mousedown", {
                                clientX: touch.clientX,
                                clientY: touch.clientY
                            });
                            canvas.dispatchEvent(mouseEvent);
                        }, false);
                        canvas.addEventListener("touchend", function (e) {
                            var mouseEvent = new MouseEvent("mouseup", {});
                            canvas.dispatchEvent(mouseEvent);
                        }, false);
                        canvas.addEventListener("touchmove", function (e) {
                            var touch = e.touches[0];
                            var mouseEvent = new MouseEvent("mousemove", {
                                clientX: touch.clientX,
                                clientY: touch.clientY
                            });
                            canvas.dispatchEvent(mouseEvent);
                        }, false);

                        // Prevent scrolling when touching the canvas
                        document.body.addEventListener("touchstart", function (e) {
                            if (e.target == canvas) {
                                e.preventDefault();
                            }
                        }, false);
                        document.body.addEventListener("touchend", function (e) {
                            if (e.target == canvas) {
                                e.preventDefault();
                            }
                        }, false);
                        document.body.addEventListener("touchmove", function (e) {
                            if (e.target == canvas) {
                                e.preventDefault();
                            }
                        }, false);

                        // Get the position of the mouse relative to the canvas
                        function getMousePos(canvasDom, mouseEvent) {
                            var rect = canvasDom.getBoundingClientRect();
                            return {
                                x: mouseEvent.clientX - rect.left,
                                y: mouseEvent.clientY - rect.top
                            };
                        }

                        // Get the position of a touch relative to the canvas
                        function getTouchPos(canvasDom, touchEvent) {
                            var rect = canvasDom.getBoundingClientRect();
                            return {
                                x: touchEvent.touches[0].clientX - rect.left,
                                y: touchEvent.touches[0].clientY - rect.top
                            };
                        }

                        // Draw to the canvas
                        function renderCanvas() {
                            if (drawing) {
                                ctx.moveTo(lastPos.x, lastPos.y);
                                ctx.lineTo(mousePos.x, mousePos.y);
                                ctx.stroke();
                                lastPos = mousePos;
                            }
                        }

                        function clearCanvas() {
                            canvas.width = canvas.width;
                        }

                        // Allow for animation
                        (function drawLoop() {
                            requestAnimFrame(drawLoop);
                            renderCanvas();
                        })();

                    })();

                }
            }

            //FIN DE CARGA DE ELEMENTOS
            //SCRIPTS
            if (document.getElementById("brands_list")) {
                getBrands();
            }

            (function ($) {
                'use strict';
                $('.dropify').dropify();

                $('.dropifyIMG').dropify({
                    messages: {
                        'default': 'Take a photo',
                    }
                });


            })(jQuery);

        });
    };

    function getCookie(cname) {
        var name = cname + "=";
        var decodedCookie = decodeURIComponent(document.cookie);
        var ca = decodedCookie.split(';');
        for (var i = 0; i < ca.length; i++) {
            var c = ca[i];
            while (c.charAt(0) == ' ') {
                c = c.substring(1);
            }
            if (c.indexOf(name) == 0) {
                return c.substring(name.length, c.length);
            }
        }
        return "";
    }

        $(document).ready(function () {
            //Select a localstorage, buscando ID de actividad
            var idVisita;
            try {
                idVisita = @ViewBag.idvisita;
            } catch{
                idVisita = "@ViewBag.idvisita";

            }
            
            if (idVisita == "copy") {
                idVisita = getCookie("IDactivitycopy");
            }
            var retrievedArrayF = JSON.parse(localStorage.getItem('FormsM_details'));
            var resultado;
            //Filtramos por actividad
            if (idVisita.toString().length > 4) {
                if (idVisita.toString().substring(0, 4) == "copy") {
                    resultado = retrievedArrayF.filter(item => item.query2 === idVisita);
                } else {
                    resultado = retrievedArrayF.filter(item => item.ID_visit === idVisita);
                }
            } else {
                resultado = retrievedArrayF.filter(item => item.ID_visit === idVisita);
            }

            

            OrderedList(resultado, "#main_container");

            });

</script>
<!--SCRIPT PARA GUARDAR IMAGENES TIEMPO REAL -->
<script>
    function dataURItoBlob(dataURI) {
        'use strict'
        var byteString,
            mimestring

        if (dataURI.split(',')[0].indexOf('base64') !== -1) {
            byteString = atob(dataURI.split(',')[1])
        } else {
            byteString = decodeURI(dataURI.split(',')[1])
        }

        mimestring = dataURI.split(',')[0].split(':')[1].split(';')[0]

        var content = new Array();
        for (var i = 0; i < byteString.length; i++) {
            content[i] = byteString.charCodeAt(i)
        }

        return new Blob([new Uint8Array(content)], { type: mimestring });
    }

    function isPortrait(img) {
        var w = img.naturalWidth || img.width,
            h = img.naturalHeight || img.height;
        return (h > w);
    }

    function getOrientation(file, callback) {
        var reader = new FileReader();

        reader.onload = function (event) {
            var view = new DataView(event.target.result);

            if (view.getUint16(0, false) != 0xFFD8) return callback(-2);

            var length = view.byteLength,
                offset = 2;

            while (offset < length) {
                var marker = view.getUint16(offset, false);
                offset += 2;

                if (marker == 0xFFE1) {
                    if (view.getUint32(offset += 2, false) != 0x45786966) {
                        return callback(-1);
                    }
                    var little = view.getUint16(offset += 6, false) == 0x4949;
                    offset += view.getUint32(offset + 4, little);
                    var tags = view.getUint16(offset, little);
                    offset += 2;

                    for (var i = 0; i < tags; i++)
                        if (view.getUint16(offset + (i * 12), little) == 0x0112)
                            return callback(view.getUint16(offset + (i * 12) + 8, little));
                }
                else if ((marker & 0xFF00) != 0xFF00) break;
                else offset += view.getUint16(offset, false);
            }
            return callback(-1);
        };

        reader.readAsArrayBuffer(file.slice(0, 64 * 1024));
    };

    $(document).on('change', 'input[type=file]', function () {
        //Le decimos que por cada input file que encuentre hara este proceso
        // Checking whether FormData is available in browser
        if (isOnLine()) {
            if (window.FormData !== undefined) {
                //$.each($('input[type="file"]'), function () {
                var ID = $(this).attr('id');

                $('#loading').show();
                setTimeout(function () {
                    $('#loading').hide();
                }, 2000);

                //COPIAMOS LA IMG A UN IMG INPUT
                var url = $(this).val();
                var ext = url.substring(url.lastIndexOf('.') + 1).toLowerCase();
                if ($(this).files && $(this).files[0] && (ext == "gif" || ext == "png" || ext == "jpeg" || ext == "jpg")) {
                    var reader = new FileReader();

                    reader.onload = function (e) {
                        $('#img_' + ID).attr('src', e.target.result);
                    }

                    reader.readAsDataURL(input.files[0]);
                } else {

                }
                //???????





                $(this).attr('data-changeflag', '0');

            var idVisita;
            try {
                idVisita = @ViewBag.idvisita;
            } catch{
                idVisita = "@ViewBag.idvisita";

            }          
            if (idVisita == "copy") {
                idVisita = getCookie("IDactivitycopy");
            }
                //var idvisita = "";
                //idvisita = document.getElementById('idvisita').value;
                //COMPRESIONAR IMAGEN
                var output_format = "jpg";


                //**************************
                var fileUpload = $("#" + ID).get(0);


                if (fileUpload.files[0].type == "image/png") {
                    output_format = "png";
                }

                //console.log(fileUpload.files[0]);
                //console.log(fileUpload.files[0].type);

                var quality = parseInt(13);
                //*****
                var source_image = document.getElementById('img_' + ID);
                var result_image = document.getElementById('resultimg_' + ID);
                var file = fileUpload.files[0],
                    reader = new FileReader();
                reader.onload = function (event) {
                    var i = document.getElementById('img_' + ID);
                    i.src = event.target.result;
                    i.onload = function () {
                        image_width = $(i).width(),
                            image_height = $(i).height();

                        if (image_width > image_height) {
                            i.style.width = "320px";
                        } else {
                            i.style.height = "300px";
                        }




                        result_image.src = jic.compress(source_image, quality, output_format).src;

                        result_image.onload = function () {
                            var image_width = $(result_image).width(),
                                image_height = $(result_image).height();

                            if (image_width > image_height) {
                                result_image.style.width = "320px";
                            } else {
                                result_image.style.height = "300px";
                            }


                            // Create FormData object
                            var or = 0;
                            getOrientation(file, function (orientation) {

                                var dataurl = result_image.src;
                                var blob = dataURItoBlob(dataurl);




                                //var files = file;

                                var fileData = new FormData();
                                fileData.append("myFile", blob, "IMG.jpg");
                                // Looping over all files and add it to FormData object
                                //for (var i = 0; i < files.length; i++) {
                                //    fileData.append(files[i].name, files[i]);
                                //}

                                // Adding one more key to FormData object
                                fileData.append('id', ID);
                                fileData.append('idvisita', idVisita);
                                fileData.append('orientation', orientation);
                                //if true rotate to the right

                                $.ajax({
                                    url: '/FormsM/UploadFiles',
                                    type: "POST",
                                    contentType: false, // Not to set any content header
                                    processData: false, // Not to process data
                                    //async: true,
                                    timeout: 80000,
                                    data: fileData,
                                    success: function (result) {
                                        //$("#modal_demoform_saving").modal('hide');
                                        $("#loading").hide();
                                    },
                                    error: function (err) {
                                        //$("#modal_demoform_saving").modal('hide');
                                        //alert("An error is reported. Maximum request length exceeded");
                                        $("#loading").hide();
                                    }
                                });

                            });



                        }
                    }
                };

                reader.readAsDataURL(file);






                //});


            }


            else {
                alert("FormData is not supported.");
            }

        } else {
            $.toast({
                heading: 'Warning',
                text: 'You must have internet connection. Please check and try again',
                loader: false,        // Change it to false to disable loader
                showHideTransition: 'slide',
                icon: 'warning',
                loaderBg: '#ff9900',
                hideAfter: 5000,
                position: 'top-right'
            });
            

        }


    });


</script>

<!--GUARDAR OBJETOS POR SEPARADO-->
<script type="text/javascript">
    function isOnLine() {
        return navigator.onLine;
    }

    $(document).on('focusout', 'input.form-control[type="text"]', function () {
        $("#loading").hide();
        var idvisita = "";
        idvisita = document.getElementById('idvisita').value; //actividad
        //GUARDAMOS OBJETOS
        var objects = [];
        //alert("ID:" + $(this).attr('id') + "value: " + $(this).val());

        objects.push({
            id: $(this).attr('id'),
            value: $(this).val(),
            text: ""
        });

        if (isOnLine()) {

//En toda accion de guardar, primero siempre ira al localstorage como update y luego al server
            //Guardamos en local
            var retrievedArrayF = JSON.parse(localStorage.getItem('FormsM_details'));
            //filtramos por actividad ((NO SE PUEDE FILTRAR PORQUE SINO, BORRAMOS TODO EL CACHE AL SOBREESCRIBIRLO))
             //= retrievedArrayfi.filter(item => item.ID_visit === idVisita);


            var idVisita;
            try {
                idVisita = @ViewBag.idvisita;
            } catch{
                idVisita = "@ViewBag.idvisita";

            }          
            if (idVisita == "copy") {
                idVisita = getCookie("IDactivitycopy");
            }



            var item;

            //Creamos un metodo diferente para recorrer los elementos ya que hay objetos child
            //los cuales no se pueden solo mandar a llamar, sino que hay que recorrerlos
            function deepSearch(container, idkey, value, text) {

                for (var i = 0; i < container.length; i++) {
                    var objeto = container[i];
                    if (idVisita.toString().length > 4) {
                        if (idVisita.toString().substring(0, 4) == "copy") {
                            if (objeto.query2 == idVisita && objeto.idkey == idkey) {
                                //Lo encontro en los parent y actualizaremos
                                item = objeto;
                                //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                                item.onserver = false;
                                item.action = "update"
                                if (value == "" || value == null) {
                                    item.fsource = ""
                                } else {
                                    item.fsource = value;
                                }



                                break;
                            } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                                if (objeto.children.length > 0) {
                                    deepSearch(objeto.children, idkey, value, text);
                                }
                            }
                        } else { //ES COPIA
                            if (objeto.ID_visit == idVisita && objeto.idkey == idkey) {
                                //Lo encontro en los parent y actualizaremos
                                item = objeto;
                                //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                                item.onserver = false;
                                item.action = "update"
                                if (value == "" || value == null) {
                                    item.fsource = ""
                                } else {
                                    item.fsource = value;
                                }



                                break;
                            } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                                if (objeto.children.length > 0) {
                                    deepSearch(objeto.children, idkey, value, text);
                                }
                            }
                        }
                    } else { //NO ES COPIA
                        if (objeto.ID_visit == idVisita && objeto.idkey == idkey) {
                            //Lo encontro en los parent y actualizaremos
                            item = objeto;
                            //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                            item.onserver = false;
                            item.action = "update"
                            if (value == "" || value == null) {
                                item.fsource = ""
                            } else {
                                item.fsource = value;
                            }



                            break;
                        } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                            if (objeto.children.length > 0) {
                                deepSearch(objeto.children, idkey, value, text);
                            }
                        }
                    }
                }

            }

            objects.forEach(function (element) {
                var id = element.id;
                var val = element.value;
                var txt = element.text;
                deepSearch(retrievedArrayF, id, val, txt);
            });

            localStorage.setItem('FormsM_details', JSON.stringify(retrievedArrayF));


            //Guardamos en server
            $.ajax({
                url: '/FormsM/Save_activityByitem',
                type: 'POST',
                data: { 'id': idvisita, 'objects': objects },
                cache: false,
                global: false,
                success: function (result) {

                    if (result.Result == "Success") {
                        $("#loading").hide();
                                    //Guardamos en local
            var retrievedArrayF = JSON.parse(localStorage.getItem('FormsM_details'));
            //filtramos por actividad ((NO SE PUEDE FILTRAR PORQUE SINO, BORRAMOS TODO EL CACHE AL SOBREESCRIBIRLO))
             //= retrievedArrayfi.filter(item => item.ID_visit === idVisita);

  
            var item;

            //Creamos un metodo diferente para recorrer los elementos ya que hay objetos child
            //los cuales no se pueden solo mandar a llamar, sino que hay que recorrerlos
            function deepSearch(container, idkey, value, text) {

                for (var i = 0; i < container.length; i++) {
                    var objeto = container[i];
                    if (idVisita.toString().length > 4) {
                        if (idVisita.toString().substring(0, 4) == "copy") { //ES COPIA
                            if (objeto.query2 == idVisita && objeto.idkey == idkey) {
                                //Lo encontro en los parent y actualizaremos
                                item = objeto;
                                //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                                item.onserver = false;
                                item.action = "saved"

                                break;
                            } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                                if (objeto.children.length > 0) {
                                    deepSearch(objeto.children, idkey, value, text);
                                }
                            }
                        } else { //NO ES COPIA
                            if (objeto.ID_visit == idVisita && objeto.idkey == idkey) {
                                //Lo encontro en los parent y actualizaremos
                                item = objeto;
                                //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                                item.onserver = false;
                                item.action = "saved"

                                break;
                            } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                                if (objeto.children.length > 0) {
                                    deepSearch(objeto.children, idkey, value, text);
                                }
                            }
                        }

                    }
                    else { //NO ES COPIA
                        if (objeto.ID_visit == idVisita && objeto.idkey == idkey) {
                            //Lo encontro en los parent y actualizaremos
                            item = objeto;
                            //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                            item.onserver = false;
                            item.action = "saved"

                            break;
                        } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                            if (objeto.children.length > 0) {
                                deepSearch(objeto.children, idkey, value, text);
                            }
                        }
                    }



                }

            }

            objects.forEach(function (element) {
                var id = element.id;
                var val = element.value;
                var txt = element.text;
                deepSearch(retrievedArrayF, id, val, txt);
            });

            localStorage.setItem('FormsM_details', JSON.stringify(retrievedArrayF));

                    } else {
                        $("#loading").hide();


                    }


                },
                error: function (request) {
                    $("#loading").hide();



                }
            });
        }
        else {//OFFLINE
            //En toda accion de guardar, primero siempre ira al localstorage como update y luego al server
            //Guardamos en local
            var retrievedArrayF = JSON.parse(localStorage.getItem('FormsM_details'));
            //filtramos por actividad ((NO SE PUEDE FILTRAR PORQUE SINO, BORRAMOS TODO EL CACHE AL SOBREESCRIBIRLO))
             //= retrievedArrayfi.filter(item => item.ID_visit === idVisita);
            var idVisita;
            try {
                idVisita = @ViewBag.idvisita;
            } catch{
                idVisita = "@ViewBag.idvisita";

            }          
            if (idVisita == "copy") {
                idVisita = getCookie("IDactivitycopy");
            }
            var item;

            //Creamos un metodo diferente para recorrer los elementos ya que hay objetos child
            //los cuales no se pueden solo mandar a llamar, sino que hay que recorrerlos
            function deepSearch(container, idkey, value, text) {

                for (var i = 0; i < container.length; i++) {
                    var objeto = container[i];
                    if (idVisita.toString().length > 4) {
                        if (idVisita.toString().substring(0, 4) == "copy") {
                            if (objeto.query2 == idVisita && objeto.idkey == idkey) {
                                //Lo encontro en los parent y actualizaremos
                                item = objeto;
                                //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                                item.onserver = false;
                                item.action = "update"
                                if (value == "" || value == null) {
                                    item.fsource = ""
                                } else {
                                    item.fsource = value;
                                }



                                break;
                            } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                                if (objeto.children.length > 0) {
                                    deepSearch(objeto.children, idkey, value, text);
                                }
                            }
                        } else { //NO ES COPIA
                            if (objeto.ID_visit == idVisita && objeto.idkey == idkey) {
                                //Lo encontro en los parent y actualizaremos
                                item = objeto;
                                //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                                item.onserver = false;
                                item.action = "update"
                                if (value == "" || value == null) {
                                    item.fsource = ""
                                } else {
                                    item.fsource = value;
                                }



                                break;
                            } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                                if (objeto.children.length > 0) {
                                    deepSearch(objeto.children, idkey, value, text);
                                }
                            }
                        }

                    } else { //NO ES COPIA
                        if (objeto.ID_visit == idVisita && objeto.idkey == idkey) {
                            //Lo encontro en los parent y actualizaremos
                            item = objeto;
                            //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                            item.onserver = false;
                            item.action = "update"
                            if (value == "" || value == null) {
                                item.fsource = ""
                            } else {
                                item.fsource = value;
                            }



                            break;
                        } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                            if (objeto.children.length > 0) {
                                deepSearch(objeto.children, idkey, value, text);
                            }
                        }
                    }


                }

            }

            objects.forEach(function (element) {
                var id = element.id;
                var val = element.value;
                var txt = element.text;
                deepSearch(retrievedArrayF, id, val, txt);
            });

            localStorage.setItem('FormsM_details', JSON.stringify(retrievedArrayF));

        }

    });

    $(document).on('focusout', 'textarea.form-control', function () {
        $("#loading").hide();
        var idvisita = "";
        idvisita = document.getElementById('idvisita').value;
        //GUARDAMOS OBJETOS
        var objects = [];
        //alert("ID:" + $(this).attr('id') + "value: " + $(this).val());
        objects.push({
            id: $(this).attr('id'),
            value: $(this).val(),
            text: ""
        });

        if (isOnLine()) {

//En toda accion de guardar, primero siempre ira al localstorage como update y luego al server
            //Guardamos en local
            var retrievedArrayF = JSON.parse(localStorage.getItem('FormsM_details'));
            //filtramos por actividad ((NO SE PUEDE FILTRAR PORQUE SINO, BORRAMOS TODO EL CACHE AL SOBREESCRIBIRLO))
             //= retrievedArrayfi.filter(item => item.ID_visit === idVisita);

           var idVisita;
            try {
                idVisita = @ViewBag.idvisita;
            } catch{
                idVisita = "@ViewBag.idvisita";

            }          
            if (idVisita == "copy") {
                idVisita = getCookie("IDactivitycopy");
            }

            var item;

            //Creamos un metodo diferente para recorrer los elementos ya que hay objetos child
            //los cuales no se pueden solo mandar a llamar, sino que hay que recorrerlos
            function deepSearch(container, idkey, value, text) {

                for (var i = 0; i < container.length; i++) {
                    var objeto = container[i];
                    if (idVisita.toString().length > 4) {
                        if (idVisita.toString().substring(0, 4) == "copy") {//ES COPIA
                            if (objeto.query2 == idVisita && objeto.idkey == idkey) {
                                //Lo encontro en los parent y actualizaremos
                                item = objeto;
                                //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                                item.onserver = false;
                                item.action = "update"
                                if (value == "" || value == null) {
                                    item.fsource = ""
                                } else {
                                    item.fsource = value;
                                }



                                break;
                            } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                                if (objeto.children.length > 0) {
                                    deepSearch(objeto.children, idkey, value, text);
                                }
                            }
                        } else { //NO ES COPIA
                            if (objeto.ID_visit == idVisita && objeto.idkey == idkey) {
                                //Lo encontro en los parent y actualizaremos
                                item = objeto;
                                //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                                item.onserver = false;
                                item.action = "update"
                                if (value == "" || value == null) {
                                    item.fsource = ""
                                } else {
                                    item.fsource = value;
                                }



                                break;
                            } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                                if (objeto.children.length > 0) {
                                    deepSearch(objeto.children, idkey, value, text);
                                }
                            }
                        }

                    } else { //NO ES COPIA
                        if (objeto.ID_visit == idVisita && objeto.idkey == idkey) {
                            //Lo encontro en los parent y actualizaremos
                            item = objeto;
                            //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                            item.onserver = false;
                            item.action = "update"
                            if (value == "" || value == null) {
                                item.fsource = ""
                            } else {
                                item.fsource = value;
                            }



                            break;
                        } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                            if (objeto.children.length > 0) {
                                deepSearch(objeto.children, idkey, value, text);
                            }
                        }
                    }


                }

            }

            objects.forEach(function (element) {
                var id = element.id;
                var val = element.value;
                var txt = element.text;
                deepSearch(retrievedArrayF, id, val, txt);
            });

            localStorage.setItem('FormsM_details', JSON.stringify(retrievedArrayF));


            //Guardamos en server
            $.ajax({
                url: '/FormsM/Save_activityByitem',
                type: 'POST',
                data: { 'id': idvisita, 'objects': objects },
                cache: false,
                global: false,
                success: function (result) {

                    if (result.Result == "Success") {

            //Guardamos en local
            var retrievedArrayF = JSON.parse(localStorage.getItem('FormsM_details'));
            //filtramos por actividad ((NO SE PUEDE FILTRAR PORQUE SINO, BORRAMOS TODO EL CACHE AL SOBREESCRIBIRLO))
             //= retrievedArrayfi.filter(item => item.ID_visit === idVisita);
            var item;

            //Creamos un metodo diferente para recorrer los elementos ya que hay objetos child
            //los cuales no se pueden solo mandar a llamar, sino que hay que recorrerlos
            function deepSearch(container, idkey, value, text) {

                for (var i = 0; i < container.length; i++) {
                    var objeto = container[i];
                    if (idVisita.toString().length > 4) {
                        if (idVisita.toString().substring(0, 4) == "copy") {//ES COPIA
                            if (objeto.query2 == idVisita && objeto.idkey == idkey) {
                                //Lo encontro en los parent y actualizaremos
                                item = objeto;
                                //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                                item.onserver = false;
                                item.action = "saved"

                                break;
                            } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                                if (objeto.children.length > 0) {
                                    deepSearch(objeto.children, idkey, value, text);
                                }
                            }
                        } else { //NO ES COPIA
                            if (objeto.ID_visit == idVisita && objeto.idkey == idkey) {
                                //Lo encontro en los parent y actualizaremos
                                item = objeto;
                                //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                                item.onserver = false;
                                item.action = "saved"

                                break;
                            } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                                if (objeto.children.length > 0) {
                                    deepSearch(objeto.children, idkey, value, text);
                                }
                            }
                        }

                    } else { //NO ES COPIA
                        if (objeto.ID_visit == idVisita && objeto.idkey == idkey) {
                            //Lo encontro en los parent y actualizaremos
                            item = objeto;
                            //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                            item.onserver = false;
                            item.action = "saved"

                            break;
                        } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                            if (objeto.children.length > 0) {
                                deepSearch(objeto.children, idkey, value, text);
                            }
                        }
                    }


                }

            }

            objects.forEach(function (element) {
                var id = element.id;
                var val = element.value;
                var txt = element.text;
                deepSearch(retrievedArrayF, id, val, txt);
            });

            localStorage.setItem('FormsM_details', JSON.stringify(retrievedArrayF));

                    } else {
                        $("#loading").hide();


                    }


                },
                error: function (request) {
                    $("#loading").hide();



                }
            });
        } else { //OFFLINE
//En toda accion de guardar, primero siempre ira al localstorage como update y luego al server
            //Guardamos en local
            var retrievedArrayF = JSON.parse(localStorage.getItem('FormsM_details'));
            //filtramos por actividad ((NO SE PUEDE FILTRAR PORQUE SINO, BORRAMOS TODO EL CACHE AL SOBREESCRIBIRLO))
             //= retrievedArrayfi.filter(item => item.ID_visit === idVisita);

            var idVisita;
            try {
                idVisita = @ViewBag.idvisita;
            } catch{
                idVisita = "@ViewBag.idvisita";

            }          
            if (idVisita == "copy") {
                idVisita = getCookie("IDactivitycopy");
            }
            var item;

            //Creamos un metodo diferente para recorrer los elementos ya que hay objetos child
            //los cuales no se pueden solo mandar a llamar, sino que hay que recorrerlos
            function deepSearch(container, idkey, value, text) {

                for (var i = 0; i < container.length; i++) {
                    var objeto = container[i];
                    if (idVisita.toString().length > 4) {
                        if (idVisita.toString().substring(0, 4) == "copy") {//ES COPIA
                            if (objeto.query2 == idVisita && objeto.idkey == idkey) {
                                //Lo encontro en los parent y actualizaremos
                                item = objeto;
                                //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                                item.onserver = false;
                                item.action = "update"
                                if (value == "" || value == null) {
                                    item.fsource = ""
                                } else {
                                    item.fsource = value;
                                }



                                break;
                            } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                                if (objeto.children.length > 0) {
                                    deepSearch(objeto.children, idkey, value, text);
                                }
                            }
                        } else { //NO ES COPIA
                            if (objeto.ID_visit == idVisita && objeto.idkey == idkey) {
                                //Lo encontro en los parent y actualizaremos
                                item = objeto;
                                //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                                item.onserver = false;
                                item.action = "update"
                                if (value == "" || value == null) {
                                    item.fsource = ""
                                } else {
                                    item.fsource = value;
                                }



                                break;
                            } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                                if (objeto.children.length > 0) {
                                    deepSearch(objeto.children, idkey, value, text);
                                }
                            }
                        }

                    } else { //NO ES COPIA
                        if (objeto.ID_visit == idVisita && objeto.idkey == idkey) {
                            //Lo encontro en los parent y actualizaremos
                            item = objeto;
                            //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                            item.onserver = false;
                            item.action = "update"
                            if (value == "" || value == null) {
                                item.fsource = ""
                            } else {
                                item.fsource = value;
                            }



                            break;
                        } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                            if (objeto.children.length > 0) {
                                deepSearch(objeto.children, idkey, value, text);
                            }
                        }
                    }


                }

            }

            objects.forEach(function (element) {
                var id = element.id;
                var val = element.value;
                var txt = element.text;
                deepSearch(retrievedArrayF, id, val, txt);
            });

            localStorage.setItem('FormsM_details', JSON.stringify(retrievedArrayF));

        }
    });


    $(document).on('focusout', 'input.form-control[type = "number"]', function () {
        $("#loading").hide();
        var idvisita = "";
        idvisita = document.getElementById('idvisita').value;
        //GUARDAMOS OBJETOS
        var objects = [];
        //alert("ID:" + $(this).attr('id') + "value: " + $(this).val());

        objects.push({
            id: $(this).attr('id'),
            value: $(this).val(),
            text: ""
        });

        if (isOnLine()) {

//En toda accion de guardar, primero siempre ira al localstorage como update y luego al server
            //Guardamos en local
            var retrievedArrayF = JSON.parse(localStorage.getItem('FormsM_details'));
            //filtramos por actividad ((NO SE PUEDE FILTRAR PORQUE SINO, BORRAMOS TODO EL CACHE AL SOBREESCRIBIRLO))
             //= retrievedArrayfi.filter(item => item.ID_visit === idVisita);

            var idVisita;
            try {
                idVisita = @ViewBag.idvisita;
            } catch{
                idVisita = "@ViewBag.idvisita";

            }          
            if (idVisita == "copy") {
                idVisita = getCookie("IDactivitycopy");
            }
            var item;

            //Creamos un metodo diferente para recorrer los elementos ya que hay objetos child
            //los cuales no se pueden solo mandar a llamar, sino que hay que recorrerlos
            function deepSearch(container, idkey, value, text) {

                for (var i = 0; i < container.length; i++) {
                    var objeto = container[i];
                    if (idVisita.toString().length > 4) {
                        if (idVisita.toString().substring(0, 4) == "copy") {//ES COPIA
                            if (objeto.query2 == idVisita && objeto.idkey == idkey) {
                                //Lo encontro en los parent y actualizaremos
                                item = objeto;
                                //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                                item.onserver = false;
                                item.action = "update"
                                if (value == "" || value == null) {
                                    item.fvalueDecimal = "0"
                                } else {
                                    item.fvalueDecimal = value;
                                }


                                break;
                            } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                                if (objeto.children.length > 0) {
                                    deepSearch(objeto.children, idkey, value, text);
                                }
                            }
                        } else { //NO ES COPIA
                            if (objeto.ID_visit == idVisita && objeto.idkey == idkey) {
                                //Lo encontro en los parent y actualizaremos
                                item = objeto;
                                //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                                item.onserver = false;
                                item.action = "update"
                                if (value == "" || value == null) {
                                    item.fvalueDecimal = "0"
                                } else {
                                    item.fvalueDecimal = value;
                                }


                                break;
                            } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                                if (objeto.children.length > 0) {
                                    deepSearch(objeto.children, idkey, value, text);
                                }
                            }
                        }
                    } else { //NO ES COPIA
                        if (objeto.ID_visit == idVisita && objeto.idkey == idkey) {
                            //Lo encontro en los parent y actualizaremos
                            item = objeto;
                            //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                            item.onserver = false;
                            item.action = "update"
                            if (value == "" || value == null) {
                                item.fvalueDecimal = "0"
                            } else {
                                item.fvalueDecimal = value;
                            }


                            break;
                        } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                            if (objeto.children.length > 0) {
                                deepSearch(objeto.children, idkey, value, text);
                            }
                        }
                    }



                }

            }

            objects.forEach(function (element) {
                var id = element.id;
                var val = element.value;
                var txt = element.text;
                deepSearch(retrievedArrayF, id, val, txt);
            });

            localStorage.setItem('FormsM_details', JSON.stringify(retrievedArrayF));


            //Guardamos en server
            $.ajax({
                url: '/FormsM/Save_activityByitem',
                type: 'POST',
                data: { 'id': idvisita, 'objects': objects },
                cache: false,
                global: false,
                success: function (result) {

                    if (result.Result == "Success") {

            //Guardamos en local
            var retrievedArrayF = JSON.parse(localStorage.getItem('FormsM_details'));
            //filtramos por actividad ((NO SE PUEDE FILTRAR PORQUE SINO, BORRAMOS TODO EL CACHE AL SOBREESCRIBIRLO))
             //= retrievedArrayfi.filter(item => item.ID_visit === idVisita);


            var item;

            //Creamos un metodo diferente para recorrer los elementos ya que hay objetos child
            //los cuales no se pueden solo mandar a llamar, sino que hay que recorrerlos
            function deepSearch(container, idkey, value, text) {

                for (var i = 0; i < container.length; i++) {
                    var objeto = container[i];
                    if (idVisita.toString().length > 4) {
                        if (idVisita.toString().substring(0, 4) == "copy") {//ES COPIA
                            if (objeto.query2 == idVisita && objeto.idkey == idkey) {
                                //Lo encontro en los parent y actualizaremos
                                item = objeto;
                                //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                                item.onserver = false;
                                item.action = "saved"

                                break;
                            } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                                if (objeto.children.length > 0) {
                                    deepSearch(objeto.children, idkey, value, text);
                                }
                            }
                        } else { //NO ES COPIA
                            if (objeto.ID_visit == idVisita && objeto.idkey == idkey) {
                                //Lo encontro en los parent y actualizaremos
                                item = objeto;
                                //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                                item.onserver = false;
                                item.action = "saved"

                                break;
                            } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                                if (objeto.children.length > 0) {
                                    deepSearch(objeto.children, idkey, value, text);
                                }
                            }
                        }

                    } else { //NO ES COPIA
                        if (objeto.ID_visit == idVisita && objeto.idkey == idkey) {
                            //Lo encontro en los parent y actualizaremos
                            item = objeto;
                            //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                            item.onserver = false;
                            item.action = "saved"

                            break;
                        } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                            if (objeto.children.length > 0) {
                                deepSearch(objeto.children, idkey, value, text);
                            }
                        }
                    }



                }

            }

            objects.forEach(function (element) {
                var id = element.id;
                var val = element.value;
                var txt = element.text;
                deepSearch(retrievedArrayF, id, val, txt);
            });

            localStorage.setItem('FormsM_details', JSON.stringify(retrievedArrayF));

                    } else {
                        $("#loading").hide();


                    }


                },
                error: function (request) {
                    $("#loading").hide();



                }
            });
        } else { //OFFLINE
//En toda accion de guardar, primero siempre ira al localstorage como update y luego al server
            //Guardamos en local
            var retrievedArrayF = JSON.parse(localStorage.getItem('FormsM_details'));
            //filtramos por actividad ((NO SE PUEDE FILTRAR PORQUE SINO, BORRAMOS TODO EL CACHE AL SOBREESCRIBIRLO))
             //= retrievedArrayfi.filter(item => item.ID_visit === idVisita);
            var idVisita;
            try {
                idVisita = @ViewBag.idvisita;
            } catch{
                idVisita = "@ViewBag.idvisita";

            }          
            if (idVisita == "copy") {
                idVisita = getCookie("IDactivitycopy");
            }
            var item;

            //Creamos un metodo diferente para recorrer los elementos ya que hay objetos child
            //los cuales no se pueden solo mandar a llamar, sino que hay que recorrerlos
            function deepSearch(container, idkey, value, text) {

                for (var i = 0; i < container.length; i++) {
                    var objeto = container[i];
                    if (idVisita.toString().length > 4) {
                        if (idVisita.toString().substring(0, 4) == "copy") {//ES COPIA
                            if (objeto.query2 == idVisita && objeto.idkey == idkey) {
                                //Lo encontro en los parent y actualizaremos
                                item = objeto;
                                //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                                item.onserver = false;
                                item.action = "update"
                                if (value == "" || value == null) {
                                    item.fvalueDecimal = "0"
                                } else {
                                    item.fvalueDecimal = value;
                                }


                                break;
                            } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                                if (objeto.children.length > 0) {
                                    deepSearch(objeto.children, idkey, value, text);
                                }
                            }
                        } else { //NO ES COPIA
                            if (objeto.ID_visit == idVisita && objeto.idkey == idkey) {
                                //Lo encontro en los parent y actualizaremos
                                item = objeto;
                                //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                                item.onserver = false;
                                item.action = "update"
                                if (value == "" || value == null) {
                                    item.fvalueDecimal = "0"
                                } else {
                                    item.fvalueDecimal = value;
                                }


                                break;
                            } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                                if (objeto.children.length > 0) {
                                    deepSearch(objeto.children, idkey, value, text);
                                }
                            }
                        }

                    } else { //NO ES COPIA
                        if (objeto.ID_visit == idVisita && objeto.idkey == idkey) {
                            //Lo encontro en los parent y actualizaremos
                            item = objeto;
                            //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                            item.onserver = false;
                            item.action = "update"
                            if (value == "" || value == null) {
                                item.fvalueDecimal = "0"
                            } else {
                                item.fvalueDecimal = value;
                            }


                            break;
                        } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                            if (objeto.children.length > 0) {
                                deepSearch(objeto.children, idkey, value, text);
                            }
                        }
                    }



                }

            }

            objects.forEach(function (element) {
                var id = element.id;
                var val = element.value;
                var txt = element.text;
                deepSearch(retrievedArrayF, id, val, txt);
            });

            localStorage.setItem('FormsM_details', JSON.stringify(retrievedArrayF));

        }
    });

    $(document).on('focusout', 'select', function () {
        $("#loading").hide();
        var idvisita = "";
        idvisita = document.getElementById('idvisita').value;
        //GUARDAMOS OBJETOS
        var objects = [];
        //alert("ID:" + $(this).attr('id') + "value: " + $(this).val());

        //alert("ID:" + $(this).attr('id') + "value: " + $(this).val());
        var str = $(this).find('option:selected').text();
        str = str.substring(str.indexOf("-") + 1);

        var final = "";
        objects.push({
            id: $(this).attr('name'),
            value: $(this).val(),
            text: str.trim()
        });

        if (isOnLine()) {
            //En toda accion de guardar, primero siempre ira al localstorage como update y luego al server
            //Guardamos en local
            var retrievedArrayF = JSON.parse(localStorage.getItem('FormsM_details'));
            //filtramos por actividad ((NO SE PUEDE FILTRAR PORQUE SINO, BORRAMOS TODO EL CACHE AL SOBREESCRIBIRLO))
             //= retrievedArrayfi.filter(item => item.ID_visit === idVisita);

            var idVisita;
            try {
                idVisita = @ViewBag.idvisita;
            } catch{
                idVisita = "@ViewBag.idvisita";

            }          
            if (idVisita == "copy") {
                idVisita = getCookie("IDactivitycopy");
            }
            var item;

            //Creamos un metodo diferente para recorrer los elementos ya que hay objetos child
            //los cuales no se pueden solo mandar a llamar, sino que hay que recorrerlos
            function deepSearch(container, idkey, value, text) {

                for (var i = 0; i < container.length; i++) {
                    var objeto = container[i];
                    if (idVisita.toString().length > 4) {
                        if (idVisita.toString().substring(0, 4) == "copy") {//ES COPIA
                            if (objeto.query2 == idVisita && objeto.idkey == idkey) {
                                //Lo encontro en los parent y actualizaremos
                                item = objeto;
                                //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                                item.onserver = false;
                                item.action = "update"
                                item.fvalueText = value;
                                item.fdescription = text;


                                break;
                            } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                                if (objeto.children.length > 0) {
                                    deepSearch(objeto.children, idkey, value, text);
                                }
                            }
                        } else { //NO ES COPIA
                            if (objeto.ID_visit == idVisita && objeto.idkey == idkey) {
                                //Lo encontro en los parent y actualizaremos
                                item = objeto;
                                //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                                item.onserver = false;
                                item.action = "update"
                                item.fvalueText = value;
                                item.fdescription = text;


                                break;
                            } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                                if (objeto.children.length > 0) {
                                    deepSearch(objeto.children, idkey, value, text);
                                }
                            }
                        }

                    } else { //NO ES COPIA
                        if (objeto.ID_visit == idVisita && objeto.idkey == idkey) {
                            //Lo encontro en los parent y actualizaremos
                            item = objeto;
                            //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                            item.onserver = false;
                            item.action = "update"
                            item.fvalueText = value;
                            item.fdescription = text;


                            break;
                        } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                            if (objeto.children.length > 0) {
                                deepSearch(objeto.children, idkey, value, text);
                            }
                        }
                    }



                }

            }

            objects.forEach(function (element) {
                var id = element.id;
                var val = element.value;
                var txt = element.text;
                deepSearch(retrievedArrayF, id, val, txt);
            });

            localStorage.setItem('FormsM_details', JSON.stringify(retrievedArrayF));


            //Guardamos en server
            $.ajax({
                url: '/FormsM/Save_activityByitem',
                type: 'POST',
                data: { 'id': idvisita, 'objects': objects },
                cache: false,
                global: false,
                success: function (result) {

                    if (result.Result == "Success") {

            //Guardamos en local
            var retrievedArrayF = JSON.parse(localStorage.getItem('FormsM_details'));
            //filtramos por actividad ((NO SE PUEDE FILTRAR PORQUE SINO, BORRAMOS TODO EL CACHE AL SOBREESCRIBIRLO))
             //= retrievedArrayfi.filter(item => item.ID_visit === idVisita);

            
            var item;

            //Creamos un metodo diferente para recorrer los elementos ya que hay objetos child
            //los cuales no se pueden solo mandar a llamar, sino que hay que recorrerlos
            function deepSearch(container, idkey, value, text) {

                for (var i = 0; i < container.length; i++) {
                    var objeto = container[i];
                    if (idVisita.toString().length > 4) {
                        if (idVisita.toString().substring(0, 4) == "copy") {//ES COPIA
                            if (objeto.query2 == idVisita && objeto.idkey == idkey) {
                                //Lo encontro en los parent y actualizaremos
                                item = objeto;
                                //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                                item.onserver = false;
                                item.action = "saved"

                                break;
                            } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                                if (objeto.children.length > 0) {
                                    deepSearch(objeto.children, idkey, value, text);
                                }
                            }
                        } else { //NO ES COPIA
                            if (objeto.ID_visit == idVisita && objeto.idkey == idkey) {
                                //Lo encontro en los parent y actualizaremos
                                item = objeto;
                                //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                                item.onserver = false;
                                item.action = "saved"

                                break;
                            } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                                if (objeto.children.length > 0) {
                                    deepSearch(objeto.children, idkey, value, text);
                                }
                            }
                        }

                    } else { //NO ES COPIA
                        if (objeto.ID_visit == idVisita && objeto.idkey == idkey) {
                            //Lo encontro en los parent y actualizaremos
                            item = objeto;
                            //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                            item.onserver = false;
                            item.action = "saved"

                            break;
                        } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                            if (objeto.children.length > 0) {
                                deepSearch(objeto.children, idkey, value, text);
                            }
                        }
                    }



                }

            }

            objects.forEach(function (element) {
                var id = element.id;
                var val = element.value;
                var txt = element.text;
                deepSearch(retrievedArrayF, id, val, txt);
            });

            localStorage.setItem('FormsM_details', JSON.stringify(retrievedArrayF));

                    } else {
                        $("#loading").hide();


                    }


                },
                error: function (request) {
                    $("#loading").hide();



                }
            });
        } else {

            //En toda accion de guardar, primero siempre ira al localstorage como update y luego al server
            //Guardamos en local
            var retrievedArrayF = JSON.parse(localStorage.getItem('FormsM_details'));
            //filtramos por actividad ((NO SE PUEDE FILTRAR PORQUE SINO, BORRAMOS TODO EL CACHE AL SOBREESCRIBIRLO))
             //= retrievedArrayfi.filter(item => item.ID_visit === idVisita);

            var idVisita;
            try {
                idVisita = @ViewBag.idvisita;
            } catch{
                idVisita = "@ViewBag.idvisita";

            }          
            if (idVisita == "copy") {
                idVisita = getCookie("IDactivitycopy");
            }
            var item;

            //Creamos un metodo diferente para recorrer los elementos ya que hay objetos child
            //los cuales no se pueden solo mandar a llamar, sino que hay que recorrerlos
            function deepSearch(container, idkey, value, text) {

                for (var i = 0; i < container.length; i++) {
                    var objeto = container[i];
                    if (idVisita.toString().length > 4) {
                        if (idVisita.toString().substring(0, 4) == "copy") {//ES COPIA
                            if (objeto.query2 == idVisita && objeto.idkey == idkey) {
                                //Lo encontro en los parent y actualizaremos
                                item = objeto;
                                //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                                item.onserver = false;
                                item.action = "update"
                                item.fvalueText = value;
                                item.fdescription = text;


                                break;
                            } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                                if (objeto.children.length > 0) {
                                    deepSearch(objeto.children, idkey, value, text);
                                }
                            }
                        } else { //NO ES COPIA
                            if (objeto.ID_visit == idVisita && objeto.idkey == idkey) {
                                //Lo encontro en los parent y actualizaremos
                                item = objeto;
                                //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                                item.onserver = false;
                                item.action = "update"
                                item.fvalueText = value;
                                item.fdescription = text;


                                break;
                            } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                                if (objeto.children.length > 0) {
                                    deepSearch(objeto.children, idkey, value, text);
                                }
                            }
                        }

                    } else { //NO ES COPIA
                        if (objeto.ID_visit == idVisita && objeto.idkey == idkey) {
                            //Lo encontro en los parent y actualizaremos
                            item = objeto;
                            //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                            item.onserver = false;
                            item.action = "update"
                            item.fvalueText = value;
                            item.fdescription = text;


                            break;
                        } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                            if (objeto.children.length > 0) {
                                deepSearch(objeto.children, idkey, value, text);
                            }
                        }
                    }



                }

            }

            objects.forEach(function (element) {
                var id = element.id;
                var val = element.value;
                var txt = element.text;
                deepSearch(retrievedArrayF, id, val, txt);
            });

            localStorage.setItem('FormsM_details', JSON.stringify(retrievedArrayF));
        }
    });

    $(document).on('click', 'input:radio', function () {
        //console.log($(this).attr('name'));
        //console.log($(this).attr('id'));


        $("#loading").hide();
        var idvisita = "";
        idvisita = document.getElementById('idvisita').value;
        //GUARDAMOS OBJETOS
        var objects = [];
        //alert("ID:" + $(this).attr('id') + "value: " + $(this).val());

        //alert("ID:" + $(this).attr('id') + "value: " + $(this).val());



        $.each($('input.form-check-input[name=' + $(this).attr('name') + ']'), function () {


            objects.push({
                id: $(this).attr('id'),
                value: $(this).prop('checked'),
                text: ""
            });
        });



        if (isOnLine()) {

            //En toda accion de guardar, primero siempre ira al localstorage como update y luego al server
            //Guardamos en local
            var retrievedArrayF = JSON.parse(localStorage.getItem('FormsM_details'));
            //filtramos por actividad ((NO SE PUEDE FILTRAR PORQUE SINO, BORRAMOS TODO EL CACHE AL SOBREESCRIBIRLO))
             //= retrievedArrayfi.filter(item => item.ID_visit === idVisita);

            var idVisita;
            try {
                idVisita = @ViewBag.idvisita;
            } catch{
                idVisita = "@ViewBag.idvisita";

            }          
            if (idVisita == "copy") {
                idVisita = getCookie("IDactivitycopy");
            }
            var item;

            //Creamos un metodo diferente para recorrer los elementos ya que hay objetos child
            //los cuales no se pueden solo mandar a llamar, sino que hay que recorrerlos
            function deepSearch(container, idkey, value, text) {

                for (var i = 0; i < container.length; i++) {
                    var objeto = container[i];
                    if (idVisita.toString().length > 4) {
                        if (idVisita.toString().substring(0, 4) == "copy") {//ES COPIA
                            if (objeto.query2 == idVisita && objeto.idkey == idkey) {
                                //Lo encontro en los parent y actualizaremos
                                item = objeto;
                                //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                                item.onserver = false;
                                item.action = "update"

                                if (value == "" || value == null) { value = false; }

                                if (value == false) {
                                    item.fvalue = 0; //Lo guardamos como entero
                                } else {
                                    item.fvalue = 1; //Lo guardamos como entero
                                }



                                break;
                            } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                                if (objeto.children.length > 0) {
                                    deepSearch(objeto.children, idkey, value, text);
                                }
                            }
                        } else { //NO ES COPIA
                            if (objeto.ID_visit == idVisita && objeto.idkey == idkey) {
                                //Lo encontro en los parent y actualizaremos
                                item = objeto;
                                //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                                item.onserver = false;
                                item.action = "update"

                                if (value == "" || value == null) { value = false; }

                                if (value == false) {
                                    item.fvalue = 0; //Lo guardamos como entero
                                } else {
                                    item.fvalue = 1; //Lo guardamos como entero
                                }



                                break;
                            } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                                if (objeto.children.length > 0) {
                                    deepSearch(objeto.children, idkey, value, text);
                                }
                            }
                        }

                    } else { //NO ES COPIA
                        if (objeto.ID_visit == idVisita && objeto.idkey == idkey) {
                            //Lo encontro en los parent y actualizaremos
                            item = objeto;
                            //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                            item.onserver = false;
                            item.action = "update"

                            if (value == "" || value == null) { value = false; }

                            if (value == false) {
                                item.fvalue = 0; //Lo guardamos como entero
                            } else {
                                item.fvalue = 1; //Lo guardamos como entero
                            }



                            break;
                        } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                            if (objeto.children.length > 0) {
                                deepSearch(objeto.children, idkey, value, text);
                            }
                        }
                    }



                }

                //getObject = null;
            }

            objects.forEach(function (element) {
                var id = element.id;
                var val = element.value;
                var txt = element.text;
                deepSearch(retrievedArrayF, id, val, txt);
            });




            //retrievedArrayF.forEach(function (objeto) {
            //    if (objeto.ID_visit == idVisita && objeto.idkey == id) {
            //                item = objeto;
            //                //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
            //                item.onserver = false;
            //                item.action = "update"

            //        if (value == "" || value == null) { value = "false"; }
            //        var seleccionado = 0;
            //        if (item.value == "false") {
            //            seleccionado = 0;
            //        }
            //        else if (item.value == "true") {
            //            seleccionado = 1;
            //        }
            //        item.fvalue = seleccionado; //Lo guardamos como entero

            //    }

            //});
            localStorage.setItem('FormsM_details', JSON.stringify(retrievedArrayF));


            //Guardamos en server
            $.ajax({
                url: '/FormsM/Save_activityByitem',
                type: 'POST',
                data: { 'id': idvisita, 'objects': objects },
                cache: false,
                global: false,
                success: function (result) {

                    if (result.Result == "Success") {

            //Guardamos en local
            var retrievedArrayF = JSON.parse(localStorage.getItem('FormsM_details'));
            //filtramos por actividad ((NO SE PUEDE FILTRAR PORQUE SINO, BORRAMOS TODO EL CACHE AL SOBREESCRIBIRLO))
             //= retrievedArrayfi.filter(item => item.ID_visit === idVisita);

            var item;

            //Creamos un metodo diferente para recorrer los elementos ya que hay objetos child
            //los cuales no se pueden solo mandar a llamar, sino que hay que recorrerlos
            function deepSearch(container, idkey, value, text) {

                for (var i = 0; i < container.length; i++) {
                    var objeto = container[i];
                    if (idVisita.toString().length > 4) {
                        if (idVisita.toString().substring(0, 4) == "copy") {//ES COPIA
                            if (objeto.query2 == idVisita && objeto.idkey == idkey) {
                                //Lo encontro en los parent y actualizaremos
                                item = objeto;
                                //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                                item.onserver = false;
                                item.action = "saved"

                                break;
                            } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                                if (objeto.children.length > 0) {
                                    deepSearch(objeto.children, idkey, value, text);
                                }
                            }
                        } else { //NO ES COPIA
                            if (objeto.ID_visit == idVisita && objeto.idkey == idkey) {
                                //Lo encontro en los parent y actualizaremos
                                item = objeto;
                                //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                                item.onserver = false;
                                item.action = "saved"

                                break;
                            } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                                if (objeto.children.length > 0) {
                                    deepSearch(objeto.children, idkey, value, text);
                                }
                            }
                        }

                    } else { //NO ES COPIA
                        if (objeto.ID_visit == idVisita && objeto.idkey == idkey) {
                            //Lo encontro en los parent y actualizaremos
                            item = objeto;
                            //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                            item.onserver = false;
                            item.action = "saved"

                            break;
                        } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                            if (objeto.children.length > 0) {
                                deepSearch(objeto.children, idkey, value, text);
                            }
                        }
                    }



                }

            }

            objects.forEach(function (element) {
                var id = element.id;
                var val = element.value;
                var txt = element.text;
                deepSearch(retrievedArrayF, id, val, txt);
            });

            localStorage.setItem('FormsM_details', JSON.stringify(retrievedArrayF));

                    } else {
                        $("#loading").hide();


                    }


                },
                error: function (request) {
                    $("#loading").hide();



                }
            });
        } else {
            //En toda accion de guardar, primero siempre ira al localstorage como update y luego al server
            //Guardamos en local
            var retrievedArrayF = JSON.parse(localStorage.getItem('FormsM_details'));
            //filtramos por actividad ((NO SE PUEDE FILTRAR PORQUE SINO, BORRAMOS TODO EL CACHE AL SOBREESCRIBIRLO))
             //= retrievedArrayfi.filter(item => item.ID_visit === idVisita);

            var idVisita;
            try {
                idVisita = @ViewBag.idvisita;
            } catch{
                idVisita = "@ViewBag.idvisita";

            }          
            if (idVisita == "copy") {
                idVisita = getCookie("IDactivitycopy");
            }
            var item;

            //Creamos un metodo diferente para recorrer los elementos ya que hay objetos child
            //los cuales no se pueden solo mandar a llamar, sino que hay que recorrerlos
            function deepSearch(container, idkey, value, text) {

                for (var i = 0; i < container.length; i++) {
                    var objeto = container[i];
                    if (idVisita.toString().length > 4) {
                        if (idVisita.toString().substring(0, 4) == "copy") {//ES COPIA

                            if (objeto.query2 == idVisita && objeto.idkey == idkey) {
                                //Lo encontro en los parent y actualizaremos
                                item = objeto;
                                //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                                item.onserver = false;
                                item.action = "update"

                                if (value == "" || value == null) { value = false; }

                                item.fvalue = value; //Lo guardamos como entero


                                break;
                            } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                                if (objeto.children.length > 0) {
                                    deepSearch(objeto.children, idkey, value, text);
                                }
                            }
                        } else { //NO ES COPIA

                            if (objeto.ID_visit == idVisita && objeto.idkey == idkey) {
                                //Lo encontro en los parent y actualizaremos
                                item = objeto;
                                //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                                item.onserver = false;
                                item.action = "update"

                                if (value == "" || value == null) { value = false; }

                                item.fvalue = value; //Lo guardamos como entero


                                break;
                            } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                                if (objeto.children.length > 0) {
                                    deepSearch(objeto.children, idkey, value, text);
                                }
                            }
                        }

                    } else { //NO ES COPIA

                        if (objeto.ID_visit == idVisita && objeto.idkey == idkey) {
                            //Lo encontro en los parent y actualizaremos
                            item = objeto;
                            //Una vez encontrado,actualizamos lo que necesitamos y cambiamos el estado.
                            item.onserver = false;
                            item.action = "update"

                            if (value == "" || value == null) { value = false; }

                            item.fvalue = value; //Lo guardamos como entero


                            break;
                        } else { //no lo encontro pero verificaremos si tiene hijos para buscar nuevamente
                            if (objeto.children.length > 0) {
                                deepSearch(objeto.children, idkey, value, text);
                            }
                        }
                    }


                }

            }

            objects.forEach(function (element) {
                var id = element.id;
                var val = element.value;
                var txt = element.text;
                deepSearch(retrievedArrayF, id, val, txt);
            });

            localStorage.setItem('FormsM_details', JSON.stringify(retrievedArrayF));

        }
    });


</script>